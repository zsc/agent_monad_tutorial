<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>Chapter 14 â€” Search API + RAGï¼šæ„å»ºæ£€ç´¢å¢å¼ºçš„ RAG Agent</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ã€Šç”¨ IO Monad æ­å»º LLM Agentï¼šä» Kleisli åˆ°äº‹ä»¶å»ºæ¨¡ä¸ FRPã€‹ç›®å½•ï¼ˆindex.mdï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 1 â€” LLM Agent çš„â€œæŠ½è±¡è¾¹ç•Œâ€ï¼šä¸ºä»€ä¹ˆä» IO Monad å‡ºå‘</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 2 â€” IO Monad é€Ÿæˆï¼šä»æ¦‚å¿µåˆ°å·¥ç¨‹å®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 3 â€” Kleisli Arrowï¼šæŠŠâ€œå¸¦ IO çš„å‡½æ•°â€å½“ä½œå¯ç»„åˆç®­å¤´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 4 â€” Agent DSLï¼šæŠŠå·¥å…·ã€è®°å¿†ä¸æ§åˆ¶æµåšæˆâ€œå¯è§£é‡Šçš„ effectâ€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 5 â€” Runtime ä¸è°ƒåº¦ï¼šä»è§£é‡Šå™¨åˆ°å¹¶å‘ã€å–æ¶ˆä¸èµ„æºç®¡ç† (chapter5.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 6 â€” äº‹ä»¶å»ºæ¨¡ï¼šIO timeoutã€é‡è¯•ã€é€€é¿ã€ç†”æ–­ä¸é¢„ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 7 â€” Coding Agent çš„ Loop Detectionï¼šè®© Agent å¯ç»ˆæ­¢ã€å¯è§£é‡Š</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 8 â€” A/B Test ä¸è¯„ä¼°ï¼šæŠŠå®éªŒåµŒè¿› IO/Kleisli ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 9 â€” å¯è§‚æµ‹æ€§ï¼šTrace/Spanã€æ—¥å¿—ã€æŒ‡æ ‡ä¸å¯å¤ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 10 â€” ä¸ FRP çš„å…³ç³»ï¼šå½“ Agent å˜æˆâ€œäº‹ä»¶æµå¤„ç†å™¨â€ (chapter10.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 11 â€” ç»¼åˆæ¡ˆä¾‹ï¼šå®ç°ä¸€ä¸ªå¯æ’æ‹”çš„ Coding Agent (chapter11.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 12 â€” æ‰©å±•é˜…è¯»ä¸è·¯çº¿å›¾ï¼šé€šå¾€ç±»å‹å®‰å…¨ä¸ç”Ÿäº§ç¯å¢ƒçš„å½¼å²¸</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 13 â€” é™„å½•ï¼šç»ˆæå‚è€ƒæ‰‹å†Œ (The Ultimate Reference)</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 14 â€” Search API + RAGï¼šæ„å»ºæ£€ç´¢å¢å¼ºçš„ RAG Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="chapter-14-search-api-rag-rag-agent">Chapter 14 â€” Search API + RAGï¼šæ„å»ºæ£€ç´¢å¢å¼ºçš„ RAG Agent</h1>
<h2 id="1">1. å¼€ç¯‡æ®µè½</h2>
<p>åœ¨ Agent çš„èƒ½åŠ›è°±ç³»ä¸­ï¼Œ<strong>æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰</strong> å æ®ç€ç‰¹æ®Šçš„åœ°ä½ã€‚å¦‚æœè¯´ Tool Use æ˜¯ Agent çš„â€œæ‰‹â€ï¼Œé‚£ä¹ˆ Search/RAG å°±æ˜¯ Agent çš„â€œçœ¼â€å’Œâ€œå¤–è„‘â€ã€‚</p>
<p>ä¸è®¡ç®—å™¨æˆ–æ—¥å†ç­‰ç¡®å®šæ€§å·¥å…·ä¸åŒï¼Œæœç´¢ï¼ˆSearchï¼‰æ˜¯ä¸€ä¸ª<strong>é«˜åº¦ä¸ç¡®å®šã€é«˜å™ªå£°ä¸”æ˜‚è´µ</strong>çš„ IO è¿‡ç¨‹ã€‚å½“ä½ æ‰§è¡Œ <code>search("Apple")</code> æ—¶ï¼Œä½ å¯èƒ½å¾—åˆ°æ°´æœï¼Œä¹Ÿå¯èƒ½å¾—åˆ°ç§‘æŠ€å…¬å¸ï¼›å¯èƒ½å¾—åˆ° 404 é¡µé¢ï¼Œä¹Ÿå¯èƒ½å¾—åˆ° SEO åƒåœ¾å†œåœºã€‚æ­¤å¤–ï¼ŒRAG ä¸ä»…ä»…æ˜¯ä¸€æ¬¡ API è°ƒç”¨ï¼Œå®ƒé€šå¸¸æ˜¯ä¸€ä¸ª<strong>é€’å½’çš„çŸ¥è¯†è·å–å›è·¯ï¼ˆKnowledge Acquisition Loopï¼‰</strong>ï¼šæŸ¥è¯¢ â†’ é˜…è¯» â†’ å‘ç°ç¼ºå£ â†’ å†æŸ¥è¯¢ã€‚</p>
<p>æœ¬ç« æ·±å…¥æ¢è®¨å¦‚ä½•å°† RAG æµç¨‹ä¸­çš„å„ä¸ªç¯èŠ‚â€”â€”æŸ¥è¯¢ç”Ÿæˆã€å¹¶å‘æ£€ç´¢ã€ç»“æœæ¸…æ´—ã€é‡æ’åºï¼ˆRerankï¼‰ã€åˆ†å—é˜…è¯»ã€è¯æ®åˆæˆâ€”â€”å»ºæ¨¡ä¸ºå¯ç»„åˆçš„ <strong>Kleisli Arrows</strong>ã€‚æˆ‘ä»¬å°†é‡ç‚¹è§£å†³â€œæœç´¢æ­»å¾ªç¯â€ã€â€œä¸Šä¸‹æ–‡æ±¡æŸ“â€å’Œâ€œå¼•ç”¨å¹»è§‰â€ç­‰æ ¸å¿ƒå·¥ç¨‹éš¾é¢˜ã€‚</p>
<p><strong>å­¦ä¹ ç›®æ ‡</strong>ï¼š</p>
<ol>
<li><strong>æ¶æ„å»ºæ¨¡</strong>ï¼šå°† RAG æ‹†è§£ä¸º <code>Query -&gt; Search -&gt; Rank -&gt; Read -&gt; Synthesize</code> çš„ Pipelineã€‚</li>
<li><strong>Effect å®šä¹‰</strong>ï¼šå®šä¹‰ Searchã€Scrapeã€VectorDB è¯»å†™çš„ Algebraã€‚</li>
<li><strong>é«˜çº§æ§åˆ¶æµ</strong>ï¼šä½¿ç”¨ Kleisli ç»„åˆå®ç° Multi-hopï¼ˆå¤šè·³ï¼‰æ£€ç´¢å’Œ Query Expansionï¼ˆæŸ¥è¯¢æ‰©å±•ï¼‰ã€‚</li>
<li><strong>å¾ªç¯æ£€æµ‹</strong>ï¼šåŸºäºè¯­ä¹‰å‘é‡çš„ Loop Detectionï¼Œé˜²æ­¢ Agent åœ¨æ— æ•ˆä¿¡æ¯ä¸­ç©ºè½¬ã€‚</li>
<li><strong>å¯ä¿¡çº¦æŸ</strong>ï¼šåˆ©ç”¨ç±»å‹ç³»ç»Ÿå¼ºåˆ¶å®ç°â€œæ— å¼•ç”¨ï¼Œä¸è¾“å‡ºâ€ã€‚</li>
</ol>
<hr />
<h2 id="2">2. æ–‡å­—è®ºè¿°</h2>
<h3 id="21-searchrag-agent">2.1 Search/RAG Agent çš„å®šä½ä¸æ¶æ„</h3>
<p>æ™®é€šçš„ LLM æ˜¯å°é—­ç³»ç»Ÿï¼ŒRAG Agent æ˜¯å¼€æ”¾ç³»ç»Ÿã€‚è¿™ç§å¼€æ”¾æ€§å¸¦æ¥äº†å·¨å¤§çš„çŠ¶æ€ç©ºé—´å¤æ‚åº¦ã€‚æˆ‘ä»¬éœ€å°† RAG è§†ä¸ºä¸€ä¸ª<strong>åŠ¨æ€çš„åé¦ˆæ§åˆ¶ç³»ç»Ÿ</strong>ï¼Œè€Œä¸æ˜¯çº¿æ€§çš„è„šæœ¬ã€‚</p>
<h4 id="211-the-rag-pipeline">2.1.1 å…¸å‹æ¶æ„æµï¼ˆThe RAG Pipelineï¼‰</h4>
<p>æˆ‘ä»¬å¯ä»¥å°† RAG æµç¨‹çœ‹ä½œæ˜¯ä¸€ç³»åˆ—æ•°æ®è½¬æ¢çš„ç»„åˆï¼š</p>
<div class="codehilite"><pre><span></span><code>       [ User Goal ]
            |
            v
    +------------------+
    |  Planner/Reason  | &lt;---(1) å†³å®šéœ€è¦æœç´¢ä»€ä¹ˆ
    +------------------+
            |
            v
     [ Query Generator ] ---(2) ç”Ÿæˆå¤šä¸ªæŸ¥è¯¢å˜ä½“ (Query Expansion)
            |
            v
    +-------+-------+
    | Parallel Exec | ---(3) å¹¶å‘æ‰§è¡Œ IO: Google / Bing / VectorDB
    +-------+-------+
            |
     (Raw Documents)
            |
            v
    [ Scrubber/Filter ] ---(4) æ¸…æ´—: å»é‡ã€å»å¹¿å‘Šã€é»‘åå•è¿‡æ»¤
            |
            v
       [ Reranker ]     ---(5) æ’åº: Cross-Encoder æ‰“åˆ† (IO/GPU Bound)
            |
            v
     [ Chunk Selector ] ---(6) è£å‰ª: é€‰å– Top-K ç‰‡æ®µä»¥é€‚åº” Context Window
            |
            v
     [ Synthesizer ]    ---(7) åˆæˆ: ç”Ÿæˆå¸¦å¼•ç”¨çš„ç­”æ¡ˆ
</code></pre></div>

<p>åœ¨ IO Monad çš„è§†è§’ä¸‹ï¼Œä¸Šè¿°æ¯ä¸€ä¸ªæ–¹æ¡†éƒ½æ˜¯ä¸€ä¸ªå‡½æ•° <code>a -&gt; m b</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>&gt;=&gt;</code> (Kleisli compose) å°†å®ƒä»¬ä¸²è”èµ·æ¥ã€‚</p>
<h3 id="22-search-effect-the-search-algebra">2.2 æŠŠ Search å½“ä½œ Effect (The Search Algebra)</h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰â€œæœç´¢â€åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿé‡Œåˆ°åº•æ„å‘³ç€ä»€ä¹ˆã€‚å®ƒä¸åº”è€¦åˆå…·ä½“çš„ä¾›åº”å•†ï¼ˆGoogle/SerpApiï¼‰ï¼Œè€Œåº”æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ä»£æ•°æ¥å£ã€‚</p>
<h4 id="221">2.2.1 ç±»å‹å®šä¹‰</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- åŸºç¡€ç±»å‹</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Url</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">String</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Snippet</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">String</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Score</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Float</span><span class="w"> </span><span class="c1">-- 0.0 to 1.0</span>

<span class="c1">-- æ–‡æ¡£æ¨¡å‹</span>
<span class="kr">data</span><span class="w"> </span><span class="kt">SearchResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">SearchResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">url</span><span class="w">   </span><span class="kt">:</span><span class="w"> </span><span class="kt">Url</span><span class="p">,</span>
<span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">body</span><span class="w">  </span><span class="kt">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="c1">-- å¯èƒ½æ˜¯æ‘˜è¦ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¨æ–‡</span>
<span class="w">    </span><span class="n">meta</span><span class="w">  </span><span class="kt">:</span><span class="w"> </span><span class="kt">Map</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="c1">-- å‘å¸ƒæ—¶é—´ã€ä½œè€…ç­‰</span>
<span class="p">}</span>

<span class="c1">-- æ ¸å¿ƒèƒ½åŠ› (Algebra)</span>
<span class="kr">class</span><span class="w"> </span><span class="kt">Monad</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">SearchAlgebra</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="kr">where</span>
<span class="w">    </span><span class="c1">-- åŸºç¡€æœç´¢ï¼šå¯èƒ½è¶…æ—¶ï¼Œå¯èƒ½å¤±è´¥</span>
<span class="w">    </span><span class="n">search</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Query</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">(</span><span class="kt">Either</span><span class="w"> </span><span class="kt">SearchError</span><span class="w"> </span><span class="p">[</span><span class="kt">SearchResult</span><span class="p">])</span>

<span class="w">    </span><span class="c1">-- è·å–è¯¦æƒ…ï¼šçˆ¬å–ç½‘é¡µå…¨æ–‡</span>
<span class="w">    </span><span class="n">scrape</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Url</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">(</span><span class="kt">Either</span><span class="w"> </span><span class="kt">ScrapeError</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- å‘é‡æ£€ç´¢ï¼šä»ç§æœ‰çŸ¥è¯†åº“è·å–</span>
<span class="w">    </span><span class="n">vectorSearch</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Vector</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">[</span><span class="kt">SearchResult</span><span class="p">]</span>
</code></pre></div>

<h4 id="222-search-m-effect">2.2.2 ä¸ºä»€ä¹ˆ <code>search</code> æ˜¯ <code>m</code> (Effect)?</h4>
<ol>
<li><strong>Latency</strong>ï¼šæœç´¢é€šå¸¸éœ€è¦ 1s+ï¼Œéœ€è¦å¼‚æ­¥å¤„ç†ã€‚</li>
<li><strong>Failure</strong>ï¼šç½‘ç»œæ³¢åŠ¨ã€é…é¢è€—å°½ï¼ˆ429 Too Many Requestsï¼‰ã€‚</li>
<li><strong>Non-determinism</strong>ï¼šæœç´¢å¼•æ“çš„æ’åç®—æ³•éšæ—¶åœ¨å˜ï¼Œä¸å¯å¤ç°ï¼ˆé™¤éå½•åˆ¶å›æ”¾ï¼‰ã€‚</li>
</ol>
<h3 id="23-rag-io">2.3 RAG çš„ IO äº‹ä»¶ä¸å¼‚å¸¸å»ºæ¨¡</h3>
<p>åœ¨ RAG æµç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†æ¯”æ™®é€š API æ›´å¤æ‚çš„â€œè½¯æ•…éšœâ€å’Œâ€œç¡¬æ•…éšœâ€ã€‚</p>
<ul>
<li><strong>ç¡¬æ•…éšœ (Hard Failures)</strong>ï¼š</li>
<li><code>Timeout</code>ï¼šæœç´¢å¼•æ“æœªåœ¨è§„å®šæ—¶é—´å†…å“åº”ã€‚</li>
<li><code>QuotaExceeded</code>ï¼šAPI Key æ²¡é’±äº†ã€‚</li>
<li>
<p><em>å¤„ç†ç­–ç•¥</em>ï¼šä½¿ç”¨ <code>CircuitBreaker</code> (ç†”æ–­å™¨) å’Œ <code>BackoffRetry</code> (æŒ‡æ•°é€€é¿é‡è¯•)ã€‚</p>
</li>
<li>
<p><strong>è½¯æ•…éšœ (Soft Failures / Data Events)</strong>ï¼š</p>
</li>
<li><code>EmptyResult</code>ï¼šæœäº†ï¼Œä½†æ²¡ç»“æœã€‚è¿™<strong>ä¸æ˜¯å¼‚å¸¸</strong>ï¼Œè€Œæ˜¯æœ‰æ•ˆçš„æ•°æ®çŠ¶æ€ã€‚</li>
<li><code>SpamDetected</code>ï¼šç»“æœå…¨æ˜¯å†…å®¹å†œåœºã€‚</li>
<li><code>StaleContent</code>ï¼šæ‰€æœ‰ç»“æœéƒ½æ˜¯ 3 å¹´å‰çš„ï¼Œæ— æ³•å›ç­”â€œæ˜¨å¤©å‘ç”Ÿäº†ä»€ä¹ˆâ€ã€‚</li>
<li><em>å¤„ç†ç­–ç•¥</em>ï¼šè¿™äº›åº”å»ºæ¨¡ä¸º <code>LogEvent</code> æˆ–æ§åˆ¶æµçš„åˆ†æ”¯æ¡ä»¶ï¼Œè§¦å‘ <code>QueryRewrite</code>ã€‚</li>
</ul>
<h3 id="24-query-kleisli">2.4 Query ç”Ÿæˆç­–ç•¥ï¼šKleisli çš„ä¸²è”ä¸åˆ†å‰</h3>
<p>ç”¨æˆ·çš„é—®é¢˜é€šå¸¸ä¸èƒ½ç›´æ¥æ‹¿å»æœç´¢ã€‚</p>
<ul>
<li>ç”¨æˆ·é—®ï¼šâ€œç‰¹æ–¯æ‹‰æœ€è¿‘é‚£ä¸ªè½¦æ€ä¹ˆæ ·ï¼Ÿâ€</li>
<li>ç›´æ¥æœï¼šâ€œç‰¹æ–¯æ‹‰æœ€è¿‘é‚£ä¸ªè½¦â€ -&gt; æ•ˆæœæå·®ã€‚</li>
<li>éœ€è¦è½¬æ¢ï¼šâ€œç‰¹æ–¯æ‹‰ Cybertruck æµ‹è¯„ 2024â€ã€â€œModel 3 Highland é©¾é©¶ä½“éªŒâ€ã€‚</li>
</ul>
<p>è¿™é‡Œæ¶‰åŠä¸¤ç§ Kleisli æ¨¡å¼ï¼š</p>
<ol>
<li>
<p><strong>Step-by-Step (Sequential)</strong>:
<code>analyzeUserIntent &gt;=&gt; generateKeywords &gt;=&gt; constructQuery</code></p>
</li>
<li>
<p><strong>Fan-out (Parallel)</strong>:
é’ˆå¯¹å¤æ‚é—®é¢˜ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç”Ÿæˆå¤šä¸ªè§†è§’çš„ Queryï¼Œå¹¶è¡Œæœç´¢ã€‚</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// TypeScript ä¼ªä»£ç ï¼šå¹¶å‘æœç´¢ Effect</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">searchEffect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">userQ</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">IO</span><span class="o">&lt;</span><span class="nx">Doc</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">generateQueries</span><span class="p">(</span><span class="nx">userQ</span><span class="p">)</span><span class="w"> </span><span class="c1">// IO&lt;Query[]&gt;</span>
<span class="w">    </span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">queries</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">       </span><span class="c1">// Parallel Traverse: å¯¹æ¯ä¸ª query æ‰§è¡Œ searchï¼Œç„¶ååˆå¹¶ç»“æœ</span>
<span class="w">       </span><span class="nx">IO</span><span class="p">.</span><span class="nx">parTraverse</span><span class="p">(</span><span class="nx">queries</span><span class="p">,</span><span class="w"> </span><span class="nx">q</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">searchService</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">q</span><span class="p">))</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">results</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">flatten</span><span class="p">(</span><span class="nx">results</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="25">2.5 ç»“æœå¤„ç†ï¼šå»é‡ã€æ¸…æ´—ä¸é‡æ’åº</h3>
<p>è¿™æ˜¯ RAG Pipeline ä¸­æœ€å®¹æ˜“è¢«å¿½è§†ä½†æœ€é‡è¦çš„ç¯èŠ‚ã€‚åƒåœ¾è¿›ï¼Œåƒåœ¾å‡ºï¼ˆGarbage In, Garbage Outï¼‰ã€‚</p>
<h4 id="251-deduplication">2.5.1 å»é‡ (Deduplication)</h4>
<p>æœç´¢ç»“æœå¾€å¾€åŒ…å«å¤§é‡å†—ä½™ï¼ˆä¸åŒ URL æŒ‡å‘åŒä¸€ç¯‡æ–‡ç« ï¼Œæˆ–è½¬è½½ï¼‰ã€‚</p>
<ul>
<li><strong>URL Normalization</strong>ï¼šç§»é™¤ <code>utm_source</code> ç­‰å‚æ•°ã€‚</li>
<li><strong>Content Hashing</strong>ï¼šè®¡ç®— Snippet çš„ MinHash æˆ– SimHashã€‚</li>
<li>è¿™é€šå¸¸æ˜¯ä¸€ä¸ª<strong>çº¯å‡½æ•°</strong>æ­¥éª¤ï¼š<code>List Doc -&gt; List Doc</code>ã€‚</li>
</ul>
<h4 id="252-reranking">2.5.2 é‡æ’åº (Reranking)</h4>
<p>æœç´¢å¼•æ“çš„ Top 10 æ˜¯åŸºäº SEO çš„ï¼ŒRAG éœ€è¦çš„æ˜¯åŸºäºâ€œè¯­ä¹‰ç›¸å…³æ€§â€çš„ã€‚
<code>Rerank</code> æ˜¯ä¸€ä¸ª Effectï¼Œå› ä¸ºå®ƒå¯èƒ½è°ƒç”¨æ˜‚è´µçš„ BERT/Cross-Encoder æ¨¡å‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Rerank æ¥å£</span>
<span class="nf">rerank</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Query</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">SearchResult</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">[</span><span class="kt">SearchResult</span><span class="p">]</span>
</code></pre></div>

<p><strong>Rule of Thumb</strong>:</p>
<ul>
<li>æœç´¢é˜¶æ®µè¿½æ±‚ <strong>Recall (å¬å›ç‡)</strong>ï¼šæ‹¿å› 50-100 ä¸ªæ–‡æ¡£ã€‚</li>
<li>æ’åºé˜¶æ®µè¿½æ±‚ <strong>Precision (ç²¾ç¡®ç‡)</strong>ï¼šç­›é€‰å‡º 5-10 ä¸ªæœ€ç›¸å…³çš„ç»™ LLMã€‚</li>
</ul>
<h3 id="26-reading-extraction">2.6 é˜…è¯»ä¸è¯æ®æŠ½å– (Reading &amp; Extraction)</h3>
<p>LLM çš„ Context Window æ˜¯æ˜‚è´µçš„ã€‚æˆ‘ä»¬ä¸èƒ½æŠŠæ•´ä¸ªç½‘é¡µå¡è¿›å»ã€‚
æˆ‘ä»¬éœ€è¦ä¸€ä¸ª <strong>Selector</strong> ç­–ç•¥ï¼š</p>
<ol>
<li><strong>Sliding Window</strong>ï¼šå°†é•¿æ–‡åˆ‡ç‰‡ã€‚</li>
<li><strong>Extraction</strong>ï¼šè®©ä¸€ä¸ªå°æ¨¡å‹ï¼ˆæˆ–å»‰ä»·æ¨¡å‹ï¼‰å…ˆè¯»ä¸€éï¼šâ€œè¿™ç¯‡æ–‡ç« é‡Œæœ‰æ²¡æœ‰æåˆ° Xï¼Ÿå¦‚æœæœ‰ï¼Œæå–é‚£ä¸€æ®µã€‚â€</li>
</ol>
<p>è¿™ä¸ªè¿‡ç¨‹å¯ä»¥å»ºæ¨¡ä¸º <code>filter</code> æ“ä½œï¼š
<code>docs.traverse(doc =&gt; analyze(doc, query))</code></p>
<h3 id="27-loop-detection">2.7 å¾ªç¯æ£€æµ‹ (Loop Detection) ä¸ é¢„ç®—æ§åˆ¶</h3>
<p>è¿™æ˜¯ RAG Agent æœ€å¤§çš„é£é™©ç‚¹ï¼š<strong>æ€ç»´ååˆï¼ˆRuminationï¼‰</strong>ã€‚
Agent å¯èƒ½ä¼šé™·å…¥ï¼š</p>
<ul>
<li>æœç´¢ "A" -&gt; æ²¡æ‰¾åˆ° -&gt; æœç´¢ "A çš„åŒä¹‰è¯" -&gt; æ²¡æ‰¾åˆ° -&gt; æœç´¢ "A çš„è‹±æ–‡" ...</li>
<li>æˆ–è€…åœ¨ä¸¤ä¸ªç›¸å…³æ¦‚å¿µé—´åå¤è·³è·ƒã€‚</li>
</ul>
<h4 id="271-detectloop-effect">2.7.1 å®ç° <code>DetectLoop</code> Effect</h4>
<p>æˆ‘ä»¬éœ€è¦ç»´æŠ¤ä¸€ä¸ª<strong>è¯­ä¹‰å†å²è®°å½•</strong>ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nx">HistoryEntry</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">embedding</span><span class="o">:</span><span class="w"> </span><span class="kt">Vector</span><span class="p">;</span><span class="w"> </span><span class="c1">// é¢„è®¡ç®—çš„å‘é‡</span>
<span class="w">  </span><span class="nx">resultCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">detectLoop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="kt">HistoryEntry</span><span class="p">[],</span><span class="w"> </span><span class="nx">newQuery</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">IO</span><span class="o">&lt;</span><span class="nx">Decision</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">embed</span><span class="p">(</span><span class="nx">newQuery</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">newVec</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ£€æŸ¥è¯­ä¹‰ç›¸ä¼¼åº¦ &gt; 0.9 çš„å†å²æŸ¥è¯¢</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">similar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">history</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">cosineSim</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">embedding</span><span class="p">,</span><span class="w"> </span><span class="nx">newVec</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">similar</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">Decision</span><span class="p">.</span><span class="nx">Abort</span><span class="p">(</span><span class="s2">&quot;Stuck in semantic loop&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">similar</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">similar</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">resultCount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">Decision</span><span class="p">.</span><span class="nx">Refine</span><span class="p">(</span><span class="s2">&quot;Previous similar query yielded nothing&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">Decision</span><span class="p">.</span><span class="nx">Proceed</span><span class="p">;</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="272-budget">2.7.2 Budget é©±åŠ¨çš„ç»ˆæ­¢</h4>
<p>RAG å¿…é¡»æ˜¯<strong>æœ‰é¢„ç®—çš„</strong>ã€‚</p>
<ul>
<li><code>MaxCalls</code>: æœ€å¤šæœç´¢ 10 æ¬¡ã€‚</li>
<li><code>TokenLimit</code>: æœ€å¤šè¯»å– 50k tokensã€‚</li>
<li><code>TimeLimit</code>: æœ€å¤šè¿è¡Œ 30 ç§’ã€‚</li>
</ul>
<p>ä¸€æ—¦ Budget è€—å°½ï¼ŒPipeline å¿…é¡»å¼ºåˆ¶é€šè¿‡ <code>Left</code> æˆ–ç‰¹å®šçŠ¶æ€è·³è½¬åˆ° <code>Synthesize</code> é˜¶æ®µï¼šâ€œåŸºäºç›®å‰å·²æœ‰çš„ä¿¡æ¯ï¼Œæˆ‘åªèƒ½å›ç­”åˆ°è¿™é‡Œ...â€ã€‚</p>
<h3 id="28-citations">2.8 å¯ä¿¡ä¸å®‰å…¨ï¼šå¼•ç”¨ (Citations)</h3>
<p>åœ¨ RAG ä¸­ï¼Œ<strong>å¹»è§‰ï¼ˆHallucinationï¼‰</strong> æ˜¯å¤´å·æ•Œäººã€‚
æˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>å‹ç³»ç»Ÿ</strong>æ¥ç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>è¦æ±‚ LLM çš„è¾“å‡ºå¿…é¡»ç¬¦åˆç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kr">data</span><span class="w"> </span><span class="kt">Claim</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Claim</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">statement</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">sourceId</span><span class="w">  </span><span class="ow">::</span><span class="w"> </span><span class="kt">DocId</span><span class="p">,</span><span class="w">  </span><span class="c1">-- å¿…é¡»æŒ‡å‘ Context ä¸­å­˜åœ¨çš„ ID</span>
<span class="w">    </span><span class="n">quote</span><span class="w">     </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w">  </span><span class="c1">-- å¿…é¡»æ˜¯åŸæ–‡çš„ç²¾ç¡®å­ä¸²</span>
<span class="p">}</span>
</code></pre></div>

<p>åœ¨ Runtimeï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª <strong>Verifier</strong>ï¼š</p>
<ol>
<li>æ£€æŸ¥ <code>sourceId</code> æ˜¯å¦åœ¨æ£€ç´¢åˆ°çš„æ–‡æ¡£åˆ—è¡¨ä¸­ã€‚</li>
<li>æ£€æŸ¥ <code>quote</code> æ˜¯å¦çœŸçš„å­˜åœ¨äºè¯¥æ–‡æ¡£ä¸­ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰ã€‚</li>
<li>æ£€æŸ¥ <code>statement</code> æ˜¯å¦è¢« <code>quote</code> é€»è¾‘è•´å«ï¼ˆNLI æ¨¡å‹ï¼‰ã€‚</li>
</ol>
<p>å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œè¿™ä¸ä»…æ˜¯ä¸€ä¸ª Logï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>åé¦ˆä¿¡å·</strong>ï¼Œå¯ä»¥è®© Agent è‡ªæˆ‘ä¿®æ­£ï¼ˆSelf-Correctionï¼‰ã€‚</p>
<h3 id="29-frp">2.9 ä¸ FRP çš„å…³ç³»ï¼šæµå¼é€æ˜åŒ–</h3>
<p>RAG è¿‡ç¨‹å¾ˆæ…¢ã€‚ç”¨æˆ·éœ€è¦çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€‚
åˆ©ç”¨ FRPï¼ˆFunctional Reactive Programmingï¼‰ï¼Œæˆ‘ä»¬å°† RAG å»ºæ¨¡ä¸ºäº‹ä»¶æµï¼š</p>
<ul>
<li><code>Stream&lt;Event&gt;</code>:</li>
<li><code>Thinking: "Analysing user query..."</code></li>
<li><code>Action: "Searching Google for 'React 19 release date'..."</code></li>
<li><code>Data: "Found 5 relevant pages."</code></li>
<li><code>Action: "Reading 'React Blog'..."</code></li>
<li><code>Progress: "Reading 3/5 docs..."</code></li>
<li><code>Output: "React 19 was released on..."</code></li>
</ul>
<p>è¿™ç§æ¨¡å¼ä¸‹ï¼ŒUI åªæ˜¯è¿™ä¸ª Stream çš„æ¶ˆè´¹è€…ã€‚IO Monad è´Ÿè´£æ‰§è¡Œï¼ŒFRP è´Ÿè´£å°†æ‰§è¡Œè¿‡ç¨‹å¹¿æ’­å‡ºå»ã€‚</p>
<hr />
<h2 id="3">3. æœ¬ç« å°ç»“</h2>
<ul>
<li><strong>RAG æ˜¯ IO å¯†é›†å‹ç®¡é“</strong>ï¼šå®ƒç”±æŸ¥è¯¢ç”Ÿæˆã€æœç´¢æ‰§è¡Œã€æ¸…æ´—ã€é‡æ’åºã€é˜…è¯»ã€åˆæˆå…­å¤§ç¯èŠ‚ç»„æˆã€‚</li>
<li><strong>Ranking æ˜¯å…³é”® Effect</strong>ï¼šä¸è¦åªä¾èµ–æœç´¢å¼•æ“çš„åŸå§‹æ’åºï¼Œå¿…é¡»åœ¨æœ¬åœ°ï¼ˆæˆ–é€šè¿‡æ¨¡å‹ APIï¼‰è¿›è¡Œè¯­ä¹‰é‡æ’åºï¼ˆRerankï¼‰ã€‚</li>
<li><strong>è¯­ä¹‰å¾ªç¯æ£€æµ‹</strong>ï¼šä¼ ç»Ÿçš„å­—ç¬¦ä¸²åŒ¹é…æ— æ³•æ£€æµ‹â€œæ¢è¯æœç´¢â€çš„æ­»å¾ªç¯ï¼Œå¿…é¡»å¼•å…¥ Embedding ç›¸ä¼¼åº¦æ£€æµ‹ã€‚</li>
<li><strong>å¼•ç”¨å³ç±»å‹çº¦æŸ</strong>ï¼šé€šè¿‡å¼ºåˆ¶è¦æ±‚è¾“å‡ºåŒ…å«åŸæ–‡å¼•ç”¨ï¼ˆQuoteï¼‰å’Œæ¥æº IDï¼Œå¹¶å°†éªŒè¯é€»è¾‘çº³å…¥ Pipelineï¼Œå¯ä»¥å¤§å¹…é™ä½å¹»è§‰ã€‚</li>
<li><strong>æ‹¥æŠ±ä¸ç¡®å®šæ€§</strong>ï¼šæœç´¢å¯èƒ½ä¸ºç©ºã€è¶…æ—¶æˆ–è¢«æ±¡æŸ“ã€‚Agent å¿…é¡»å…·å¤‡å¤„ç† <code>Either Error EmptyResult</code> çš„åˆ†æ”¯é€»è¾‘ï¼Œè€Œä¸æ˜¯å‡è®¾æ€»èƒ½æœåˆ°ç­”æ¡ˆã€‚</li>
</ul>
<hr />
<h2 id="4">4. ç»ƒä¹ é¢˜</h2>
<h3 id="_1">åŸºç¡€é¢˜</h3>
<details>
<summary><strong>ä¹ é¢˜ 1ï¼šå®ç°åŸºç¡€ Search Algebra</strong></summary>
<p><strong>é¢˜ç›®</strong>ï¼šå®šä¹‰ä¸€ä¸ªç®€å•çš„ <code>Search</code> æ¥å£ï¼Œå¹¶å®ç°ä¸€ä¸ª <code>MockSearchInterpreter</code>ã€‚è¯¥è§£é‡Šå™¨åŒ…å«ä¸€ä¸ªé¢„å®šä¹‰çš„å†…å­˜æ•°æ®åº“ï¼ˆMap Query [Doc]ï¼‰ã€‚å½“æŸ¥è¯¢å‘½ä¸­æ—¶è¿”å›æ–‡æ¡£ï¼Œæœªå‘½ä¸­æ—¶è¿”å›ç©ºåˆ—è¡¨ï¼Œå½“æŸ¥è¯¢ä¸º "error" æ—¶æ¨¡æ‹Ÿç½‘ç»œå¼‚å¸¸ã€‚</p>
<p><strong>Hint</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>Map&lt;String, List&lt;Document&gt;&gt;</code> ä½œä¸º Mock æ•°æ®æºã€‚</li>
<li>è¿”å›å€¼ç±»å‹åº”ä¸º <code>IO&lt;Either&lt;Error, List&lt;Document&gt;&gt;&gt;</code>ã€‚</li>
</ul>
<p><strong>å‚è€ƒç­”æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TypeScript ç¤ºä¾‹</span>
<span class="kr">type</span><span class="w"> </span><span class="nx">Doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="kr">type</span><span class="w"> </span><span class="nx">SearchResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Success&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">docs</span><span class="o">:</span><span class="w"> </span><span class="kt">Doc</span><span class="p">[]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">MockSearch</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">db</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">Doc</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">db</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">Doc</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">  </span><span class="nx">search</span><span class="p">(</span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">SearchResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ</span>
<span class="w">      </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">query</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">resolve</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Network Timeout&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">resolve</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Success&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">docs</span><span class="o">:</span><span class="w"> </span><span class="kt">this.db</span><span class="p">[</span><span class="nx">query</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>
<details>
<summary><strong>ä¹ é¢˜ 2ï¼šå¹¶å‘æœç´¢å¼•æ“ (Parallel IO)</strong></summary>
<p><strong>é¢˜ç›®</strong>ï¼šå‡è®¾ä½ æœ‰ä¸¤ä¸ªæœç´¢æº <code>searchGoogle(q)</code> å’Œ <code>searchBing(q)</code>ã€‚è¯·ç¼–å†™ä¸€ä¸ªå‡½æ•° <code>searchUnified(q)</code>ï¼Œå®ƒï¼š</p>
<ol>
<li><strong>å¹¶å‘</strong>è°ƒç”¨è¿™ä¸¤ä¸ªæœç´¢æºã€‚</li>
<li>å¦‚æœæœ‰ä»»æ„ä¸€ä¸ªå¤±è´¥ï¼Œå¿½ç•¥å®ƒï¼Œåªè¿”å›å¦ä¸€ä¸ªçš„ç»“æœã€‚</li>
<li>å¦‚æœéƒ½æˆåŠŸï¼Œåˆå¹¶ç»“æœå¹¶å»é‡ï¼ˆæ ¹æ® URLï¼‰ã€‚</li>
<li>å¦‚æœéƒ½å¤±è´¥ï¼Œè¿”å›é”™è¯¯ã€‚</li>
</ol>
<p><strong>Hint</strong>ï¼šä½¿ç”¨ <code>Promise.allSettled</code> (JS) æˆ– <code>race</code>/<code>parMap</code> (FP)ã€‚éœ€è¦å¤„ç† Partial Failureã€‚</p>
<p><strong>å‚è€ƒç­”æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä¼ªä»£ç æ€è·¯</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">searchUnified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">q</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 1. å¹¶å‘æ‰§è¡Œ</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">res1</span><span class="p">,</span><span class="w"> </span><span class="nx">res2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">allSettled</span><span class="p">([</span><span class="nx">google</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">q</span><span class="p">),</span><span class="w"> </span><span class="nx">bing</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">q</span><span class="p">)]);</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">allDocs</span><span class="o">:</span><span class="w"> </span><span class="kt">Doc</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="c1">// 2. æ”¶é›†æˆåŠŸçš„ç»“æœ</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res1</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;fulfilled&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">allDocs</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">res1</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res2</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;fulfilled&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">allDocs</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">res2</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 3. åˆ¤ç©º (å¦‚æœä¸¤ä¸ªéƒ½æŒ‚äº†ï¼Œä¸”æ²¡æœ‰ç»“æœ)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">allDocs</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">res1</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;rejected&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">res2</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;rejected&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;All providers failed&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 4. å»é‡ (Lodash uniqBy)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniqBy</span><span class="p">(</span><span class="nx">allDocs</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

</details>
<details>
<summary><strong>ä¹ é¢˜ 3ï¼šç®€å•çš„é‡è¯•ç­–ç•¥ (Retry Effect)</strong></summary>
<p><strong>é¢˜ç›®</strong>ï¼šä¸ºæœç´¢å‡½æ•°æ·»åŠ é‡è¯•é€»è¾‘ã€‚è¦æ±‚å®ç° <code>retryWithBackoff</code> é«˜é˜¶å‡½æ•°ï¼š</p>
<ul>
<li>æœ€å¤šé‡è¯• 3 æ¬¡ã€‚</li>
<li>æ¯æ¬¡é‡è¯•é—´éš”æŒ‡æ•°å¢é•¿ (1s, 2s, 4s)ã€‚</li>
<li>åªå¯¹ç‰¹å®šçš„é”™è¯¯ç±»å‹ï¼ˆå¦‚ "Timeout", "503"ï¼‰é‡è¯•ï¼Œå¯¹ "400 Bad Request" ä¸é‡è¯•ã€‚</li>
</ul>
<p><strong>Hint</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ª <code>IO</code> åŠ¨ä½œå’Œä¸€ä¸ª <code>Policy</code>ã€‚</p>
<p><strong>å‚è€ƒç­”æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">retry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">  </span><span class="nx">fn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">attempts</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">delay</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fn</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">attempts</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">isRetryable</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">sleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">retry</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span><span class="w"> </span><span class="nx">attempts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">delay</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>
<h3 id="_2">æŒ‘æˆ˜é¢˜</h3>
<details>
<summary><strong>ä¹ é¢˜ 4ï¼šå®ç° Multi-hop Reasoning çš„ Kleisli ç®¡é“</strong></summary>
<p><strong>é¢˜ç›®</strong>ï¼šæ„å»ºä¸€ä¸ªèƒ½å¤Ÿå›ç­”â€œWho is the CEO of the company that created ChatGPT?â€çš„ Agentã€‚
è¿™éœ€è¦ä¸¤æ­¥æ¨ç†ï¼š</p>
<ol>
<li>Query: "Who created ChatGPT?" -&gt; Result: "OpenAI".</li>
<li>Query: "Who is CEO of OpenAI?" -&gt; Result: "Sam Altman".
è¯·è®¾è®¡ä¸€ä¸ª <code>loop</code> å‡½æ•°ï¼Œå®ƒæ¥æ”¶ <code>UserQuery</code>ï¼Œæ‰§è¡Œæœç´¢ï¼Œè®© LLM åˆ¤æ–­æ˜¯â€œå¾—åˆ°äº†æœ€ç»ˆç­”æ¡ˆâ€è¿˜æ˜¯â€œéœ€è¦æœé›†æ›´å¤šä¿¡æ¯ï¼ˆç”Ÿæˆæ–° Queryï¼‰â€ã€‚å¦‚æœæ˜¯åè€…ï¼Œé€’å½’è°ƒç”¨ã€‚</li>
</ol>
<p><strong>Hint</strong>ï¼š
å®šä¹‰ä¸€ä¸ª Sum Type: <code>Result = FinalAnswer String | NeedMoreInfo String</code>.
å‡½æ•°ç­¾åä¸º <code>step :: Context -&gt; IO Result</code>ã€‚
ä½¿ç”¨ <code>MonadRec</code> æˆ–ç®€å•çš„é€’å½’ã€‚</p>
<p><strong>å‚è€ƒç­”æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- ä¼ªä»£ç </span>
<span class="kr">data</span><span class="w"> </span><span class="kt">StepResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Answer</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">NewQuery</span><span class="w"> </span><span class="kt">String</span>

<span class="nf">step</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Context</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="kt">StepResult</span>
<span class="nf">step</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="c1">-- LLM å†³å®šä¸‹ä¸€æ­¥</span>
<span class="w">  </span><span class="n">decision</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">llmDecide</span><span class="w"> </span><span class="n">ctx</span>
<span class="w">  </span><span class="kr">case</span><span class="w"> </span><span class="n">decision</span><span class="w"> </span><span class="kr">of</span>
<span class="w">    </span><span class="s">&quot;SEARCH&quot;</span><span class="kt">:</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
<span class="w">       </span><span class="n">docs</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">search</span><span class="w"> </span><span class="n">q</span>
<span class="w">       </span><span class="kr">let</span><span class="w"> </span><span class="n">newCtx</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">appendDocs</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="n">docs</span>
<span class="w">       </span><span class="n">step</span><span class="w"> </span><span class="n">newCtx</span><span class="w"> </span><span class="c1">-- é€’å½’ (æ³¨æ„: çœŸå®å®ç°éœ€è¦ Loop Detect å’Œ Max Depth)</span>
<span class="w">    </span><span class="s">&quot;ANSWER&quot;</span><span class="kt">:</span><span class="w"> </span><span class="n">ans</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="kt">Answer</span><span class="w"> </span><span class="n">ans</span><span class="p">)</span>

<span class="nf">runAgent</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="kt">String</span>
<span class="nf">runAgent</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="p">(</span><span class="n">initCtx</span><span class="w"> </span><span class="n">query</span><span class="p">)</span>
</code></pre></div>

</details>
<details>
<summary><strong>ä¹ é¢˜ 5ï¼šåŸºäºè¯­ä¹‰å‘é‡çš„ Loop Detection</strong></summary>
<p><strong>é¢˜ç›®</strong>ï¼šå®ç° 2.7 èŠ‚æè¿°çš„ <code>detectLoop</code>ã€‚
ä½ éœ€è¦æ¨¡æ‹Ÿä¸€ä¸ª <code>embed(text)</code> å‡½æ•°ï¼ˆè¿”å› float æ•°ç»„ï¼‰ã€‚
å¦‚æœåœ¨å†å²è®°å½•ä¸­å‘ç°æœ€è¿‘ 5 æ­¥å†…æœ‰ &gt;0.95 ç›¸ä¼¼åº¦çš„ Queryï¼Œæˆ–è€…è¿ç»­ 3 æ¬¡æœç´¢ç»“æœï¼ˆURL é›†åˆï¼‰é‡å åº¦ &gt; 80%ï¼Œåˆ™è§¦å‘ä¸­æ–­ã€‚</p>
<p><strong>Hint</strong>ï¼š
Jaccard Similarity ç”¨äºé›†åˆæ¯”è¾ƒã€‚Cosine Similarity ç”¨äºå‘é‡æ¯”è¾ƒã€‚
çŠ¶æ€ <code>State History</code> éœ€è¦åœ¨ IO ä¸­ä¼ é€’ã€‚</p>
<p><strong>å‚è€ƒç­”æ¡ˆ</strong>ï¼š
<strong>æ ¸å¿ƒé€»è¾‘</strong>ï¼š</p>
<ol>
<li><strong>State</strong>: <code>List&lt;{query: String, vec: Vector, urls: Set&lt;Url&gt;}&gt;</code></li>
<li><strong>Check 1 (Vector)</strong>: <code>dotProduct(currentVec, oldVec) &gt; 0.95</code></li>
<li><strong>Check 2 (Jaccard)</strong>: <code>intersection(currUrls, oldUrls).size / union(...).size &gt; 0.8</code></li>
<li><strong>Effect</strong>: å¦‚æœæ£€æµ‹åˆ°ï¼ŒæŠ›å‡º <code>LoopDetectedError</code> æˆ–è€…è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ <code>StopInstruction</code> ç»™ Plannerã€‚</li>
</ol>
</details>
<details>
<summary><strong>ä¹ é¢˜ 6ï¼šCitation Verifier (å¼•ç”¨éªŒè¯å™¨)</strong></summary>
<p><strong>é¢˜ç›®</strong>ï¼šç¼–å†™ä¸€ä¸ªå‡½æ•° <code>verifyCitations(answer: String, sources: Doc[]) -&gt; IO VerifiedAnswer</code>ã€‚
è¯¥å‡½æ•°éœ€è¦ï¼š</p>
<ol>
<li>è§£æ <code>answer</code> ä¸­çš„å¼•ç”¨æ ‡è®° <code>[1]</code>, <code>[2]</code>ã€‚</li>
<li>æå–å¼•ç”¨ä¸Šä¸‹æ–‡çš„ä¸€å¥è¯ã€‚</li>
<li>è°ƒç”¨ LLM (Judge) æ£€æŸ¥ï¼šåŸæ–‡ <code>sources[1]</code> æ˜¯å¦æ”¯æŒè¯¥å¥è¯çš„æ–­è¨€ã€‚</li>
<li>å¦‚æœä¸æ”¯æŒï¼Œç§»é™¤è¯¥å¼•ç”¨æˆ–æ ‡è®°ä¸ºâ€œæœªè¯å®â€ã€‚</li>
</ol>
<p><strong>Hint</strong>ï¼šè¿™æ˜¯ä¸€ä¸ª <code>Map</code> æ“ä½œï¼ŒæŠŠ <code>RawAnswer</code> æ˜ å°„ä¸º <code>VerifiedAnswer</code>ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§ RAG çš„ "Post-processing" effectã€‚</p>
<p><strong>å‚è€ƒç­”æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä¼ªä»£ç </span>
<span class="kd">const</span><span class="w"> </span><span class="nx">verify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">ans</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">docs</span><span class="o">:</span><span class="w"> </span><span class="kt">Doc</span><span class="p">[])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">extractClaims</span><span class="p">(</span><span class="nx">ans</span><span class="p">);</span><span class="w"> </span><span class="c1">// è§£æå‡ºå¥å­å’Œå¼•ç”¨å·</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">verifications</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">claims</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">docs</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">refId</span><span class="p">].</span><span class="nx">text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isSupported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">llmJudge</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">statement</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceText</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">verified</span><span class="o">:</span><span class="w"> </span><span class="kt">isSupported</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}));</span>

<span class="w">  </span><span class="c1">// é‡ç»„ç­”æ¡ˆï¼Œå»æ‰éªŒè¯å¤±è´¥çš„å¼•ç”¨</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">reconstruct</span><span class="p">(</span><span class="nx">ans</span><span class="p">,</span><span class="w"> </span><span class="nx">verifications</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

</details>
<hr />
<h2 id="5-gotchas">5. å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="51-keyword-oscillation">5.1 å…³é”®è¯éœ‡è¡ (Keyword Oscillation)</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šAgent æœç´¢ "Python tutorial" -&gt; è§‰å¾—å¤ªæµ… -&gt; æœç´¢ "Python guide" -&gt; è§‰å¾—å¤ªæµ… -&gt; æœç´¢ "Python tutorial"ã€‚</li>
<li><strong>åŸå› </strong>ï¼šPlanner æ²¡è®°ä½è‡ªå·±æœè¿‡ä»€ä¹ˆï¼Œæˆ–è€…å¯¹â€œåŒä¹‰è¯â€æ²¡æœ‰æ¦‚å¿µã€‚</li>
<li><strong>è§£å†³</strong>ï¼šå¿…é¡»ä½¿ç”¨ <strong>Embedding</strong> æ¥å¯¹æ¯”å†å² Queryï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²åŒ¹é…ã€‚å¼ºåˆ¶ Agent åœ¨é‡è¯•æ—¶â€œæ”¹å˜æœç´¢ç­–ç•¥â€ï¼ˆå¦‚ï¼šä»æœâ€œæ˜¯ä»€ä¹ˆâ€æ”¹ä¸ºæœâ€œæ€ä¹ˆåšâ€ï¼‰ã€‚</li>
</ul>
<h3 id="52-knowledge-cutoff">5.2 çŸ¥è¯†æˆªæ­¢æ—¶é—´ (Knowledge Cutoff) æ··æ·†</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šæ¨¡å‹å†…éƒ¨è®­ç»ƒæ•°æ˜¯ 2023 å¹´çš„ï¼ŒRAG æœåˆ°äº† 2024 å¹´çš„æ•°æ®ã€‚æ¨¡å‹å¯èƒ½ä¼šæ ¹æ®è‡ªå·±çš„å†…éƒ¨çŸ¥è¯†â€œçº æ­£â€RAG çš„æ­£ç¡®ç»“æœï¼ˆäº§ç”Ÿå¹»è§‰ï¼‰ã€‚</li>
<li><strong>è§£å†³</strong>ï¼šåœ¨ System Prompt ä¸­å¼ºåŠ›å‚¬çœ ï¼šâ€œä½ å¯¹ X ä¸€æ— æ‰€çŸ¥ï¼Œå¿…é¡»å®Œå…¨ä¾èµ–æä¾›çš„ Context å›ç­”ã€‚â€ æˆ–ä½¿ç”¨ <strong>Context-Only Decoding</strong> æŠ€æœ¯ã€‚</li>
</ul>
<h3 id="53">5.3 é”™è¯¯çš„ä¸Šä¸‹æ–‡æ‹¼æ¥</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šç›´æ¥æŠŠ HTML æ‰”è¿› Promptï¼Œå¯¼è‡´ Token æµªè´¹åœ¨ <code>&lt;div&gt;</code>, <code>&lt;nav&gt;</code> ä¸Šï¼›æˆ–è€…æˆªæ–­æ—¶åˆ‡æ–­äº†å…³é”®å¥å­ã€‚</li>
<li><strong>è§£å†³</strong>ï¼š</li>
<li>ä½¿ç”¨ä¸“é—¨çš„ HTML-to-Text å·¥å…·ï¼ˆå¦‚ <code>readability.js</code>ï¼‰ã€‚</li>
<li><strong>Overlapping Window</strong>ï¼šåˆ‡åˆ†æ—¶ä¿ç•™ 10% çš„é‡å ï¼Œé˜²æ­¢å…³é”®ä¿¡æ¯åˆšå¥½åœ¨åˆ‡åˆ†ç‚¹ä¸Šã€‚</li>
</ul>
<h3 id="54">5.4 å¿½è§†â€œè´Ÿåé¦ˆâ€</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šæœç´¢è¿”å›ç©ºç»“æœï¼ŒAgent ç›´æ¥å´©æºƒæˆ–çç¼–ã€‚</li>
<li><strong>è§£å†³</strong>ï¼š<strong>â€œæ²¡æœ‰ç»“æœâ€ä¹Ÿæ˜¯æå…¶é‡è¦çš„ä¿¡æ¯</strong>ã€‚å®ƒåº”è¯¥è§¦å‘ Agent çš„åæ€ï¼šâ€œæˆ‘æ˜¯ä¸æ˜¯æœé”™è¯äº†ï¼Ÿè¿˜æ˜¯è¿™ä¸ªé—®é¢˜æœ¬èº«å°±æ˜¯é”™çš„ï¼Ÿâ€ è¿™éœ€è¦åœ¨ Kleisli é“¾ä¸­å¤„ç† <code>Either Empty Result</code> çš„æƒ…å†µã€‚</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter13.html" class="nav-link prev">â† Chapter 13 â€” é™„å½•ï¼šç»ˆæå‚è€ƒæ‰‹å†Œ (The Ultimate Reference)</a><a href="CLAUDE.html" class="nav-link next">Untitled â†’</a></nav>
        </main>
    </div>
</body>
</html>