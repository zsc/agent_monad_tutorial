<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>Chapter 4 â€” Agent DSLï¼šæŠŠå·¥å…·ã€è®°å¿†ä¸æ§åˆ¶æµåšæˆâ€œå¯è§£é‡Šçš„ effectâ€</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ã€Šç”¨ IO Monad æ­å»º LLM Agentï¼šä» Kleisli åˆ°äº‹ä»¶å»ºæ¨¡ä¸ FRPã€‹ç›®å½•ï¼ˆindex.mdï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 1 â€” LLM Agent çš„â€œæŠ½è±¡è¾¹ç•Œâ€ï¼šä¸ºä»€ä¹ˆä» IO Monad å‡ºå‘</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 2 â€” IO Monad é€Ÿæˆï¼šä»æ¦‚å¿µåˆ°å·¥ç¨‹å®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 3 â€” Kleisli Arrowï¼šæŠŠâ€œå¸¦ IO çš„å‡½æ•°â€å½“ä½œå¯ç»„åˆç®­å¤´</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 4 â€” Agent DSLï¼šæŠŠå·¥å…·ã€è®°å¿†ä¸æ§åˆ¶æµåšæˆâ€œå¯è§£é‡Šçš„ effectâ€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 5 â€” Runtime ä¸è°ƒåº¦ï¼šä»è§£é‡Šå™¨åˆ°å¹¶å‘ã€å–æ¶ˆä¸èµ„æºç®¡ç† (chapter5.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 6 â€” äº‹ä»¶å»ºæ¨¡ï¼šIO timeoutã€é‡è¯•ã€é€€é¿ã€ç†”æ–­ä¸é¢„ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 7 â€” Coding Agent çš„ Loop Detectionï¼šè®© Agent å¯ç»ˆæ­¢ã€å¯è§£é‡Š</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 8 â€” A/B Test ä¸è¯„ä¼°ï¼šæŠŠå®éªŒåµŒè¿› IO/Kleisli ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 9 â€” å¯è§‚æµ‹æ€§ï¼šTrace/Spanã€æ—¥å¿—ã€æŒ‡æ ‡ä¸å¯å¤ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 10 â€” ä¸ FRP çš„å…³ç³»ï¼šå½“ Agent å˜æˆâ€œäº‹ä»¶æµå¤„ç†å™¨â€ (chapter10.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 11 â€” ç»¼åˆæ¡ˆä¾‹ï¼šå®ç°ä¸€ä¸ªå¯æ’æ‹”çš„ Coding Agent (chapter11.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 12 â€” æ‰©å±•é˜…è¯»ä¸è·¯çº¿å›¾ï¼šé€šå¾€ç±»å‹å®‰å…¨ä¸ç”Ÿäº§ç¯å¢ƒçš„å½¼å²¸</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 13 â€” é™„å½•ï¼šç»ˆæå‚è€ƒæ‰‹å†Œ (The Ultimate Reference)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 14 â€” Search API + RAGï¼šæ„å»ºæ£€ç´¢å¢å¼ºçš„ RAG Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="chapter-4-agent-dsl-effect">Chapter 4 â€” Agent DSLï¼šæŠŠå·¥å…·ã€è®°å¿†ä¸æ§åˆ¶æµåšæˆâ€œå¯è§£é‡Šçš„ effectâ€</h1>
<h2 id="1">1. å¼€ç¯‡æ®µè½ï¼šä»â€œå†™è„šæœ¬â€åˆ°â€œå†™å‰§æœ¬â€</h2>
<p>åœ¨ä¼ ç»Ÿçš„ Python è„šæœ¬å¼å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¹ æƒ¯äºç›´æ¥è°ƒç”¨ <code>openai.ChatCompletion.create</code> æˆ– <code>pinecone.upsert</code>ã€‚è¿™ç§åšæ³•åœ¨ Demo é˜¶æ®µæ•ˆç‡æé«˜ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒå’Œå¤æ‚ Agent ç³»ç»Ÿä¸­ï¼Œå®ƒä¼šå¯¼è‡´ä»£ç å˜æˆä¸€å›¢éš¾ä»¥ç»´æŠ¤çš„â€œæ„å¤§åˆ©é¢æ¡â€ï¼š</p>
<ul>
<li><strong>ä¸å¯æµ‹è¯•</strong>ï¼šå•å…ƒæµ‹è¯•éœ€è¦ mock å‡ åä¸ªä¸åŒçš„åº“å‡½æ•°ã€‚</li>
<li><strong>ä¸å¯å¤ç°</strong>ï¼šLLM çš„éšæœºæ€§ã€ç½‘ç»œæŠ–åŠ¨ã€æ—¶é—´æˆ³çš„å˜åŒ–ï¼Œä½¿å¾— Bug éš¾ä»¥é‡ç°ã€‚</li>
<li><strong>ä¸å¯è§‚æµ‹</strong>ï¼šä¸šåŠ¡é€»è¾‘ä¸å‰¯ä½œç”¨ï¼ˆIOï¼‰ç´§å¯†è€¦åˆï¼Œå¾ˆéš¾çœ‹æ¸… Agent åˆ°åº•â€œæƒ³â€åšä»€ä¹ˆï¼Œåªèƒ½çœ‹åˆ°å®ƒâ€œåšâ€äº†ä»€ä¹ˆã€‚</li>
</ul>
<p>æœ¬ç« çš„æ ¸å¿ƒæ€æƒ³ï¼š<strong>å°† Agent çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå‰§æœ¬ï¼‰ä¸æ‰§è¡Œé€»è¾‘ï¼ˆæ¼”å‡ºï¼‰å½»åº•åˆ†ç¦»</strong>ã€‚</p>
<p>æˆ‘ä»¬å°†å®šä¹‰ä¸€å¥— <strong>Domain Specific Language (DSL)</strong> â€”â€” æˆ–è€…ç§°ä¸ºâ€œä»£æ•°ï¼ˆAlgebraï¼‰â€ â€”â€” æ¥æè¿° Agent çš„æ‰€æœ‰èƒ½åŠ›ã€‚Agent ä¸å†ç›´æ¥â€œæ‰“ç”µè¯ç»™ OpenAIâ€ï¼Œè€Œæ˜¯ç”Ÿæˆä¸€ä¸ªâ€œæˆ‘æƒ³æ‰“ç”µè¯â€çš„æŒ‡ä»¤ã€‚è¿™ä¸ªæŒ‡ä»¤ç”± <strong>è§£é‡Šå™¨ï¼ˆInterpreterï¼‰</strong> æ¥æ”¶å¹¶æ‰§è¡Œã€‚è¿™ç§<strong>ä¾èµ–å€’ç½®</strong>å°†èµ‹äºˆæˆ‘ä»¬æ§åˆ¶æ—¶é—´çš„ä¸Šå¸è§†è§’ï¼šæˆ‘ä»¬å¯ä»¥è®©æ—¶é—´å€’æµã€è®© API å¿…å®šå¤±è´¥ã€æˆ–è€…è®© Agent åœ¨æ²™ç›’ä¸­ç©ºè½¬ã€‚</p>
<p><strong>æœ¬ç« å­¦ä¹ ç›®æ ‡</strong>ï¼š</p>
<ol>
<li><strong>èƒ½åŠ›å»ºæ¨¡</strong>ï¼šå¦‚ä½•å°† LLMã€å·¥å…·ã€è®°å¿†ã€æ—¶é’Ÿã€éšæœºæ•°æŠ½è±¡ä¸ºæ ‡å‡†çš„ Effectã€‚</li>
<li><strong>å®ç°èŒƒå¼</strong>ï¼šæ·±å…¥å¯¹æ¯” <strong>Final Tagless</strong>ï¼ˆåŸºäºæ¥å£ï¼‰ä¸ <strong>Free Monad</strong>ï¼ˆåŸºäºæ•°æ®ç»“æ„ï¼‰çš„å·¥ç¨‹æƒè¡¡ã€‚</li>
<li><strong>è§£é‡Šå™¨æ¨¡å¼</strong>ï¼šæ„å»ºç”Ÿäº§ï¼ˆProdï¼‰ã€æµ‹è¯•ï¼ˆTestï¼‰ã€å½•åˆ¶å›æ”¾ï¼ˆVCRï¼‰ã€ä»¥åŠâ€œäººç±»ä»‹å…¥ï¼ˆHuman-in-the-loopï¼‰â€è§£é‡Šå™¨ã€‚</li>
<li><strong>çº¯æ´æ€§åŸåˆ™</strong>ï¼šè¯†åˆ«å¹¶éš”ç¦»ä»£ç ä¸­çš„å¼å‰¯ä½œç”¨ã€‚</li>
</ol>
<hr />
<h2 id="2">2. æ–‡å­—è®ºè¿°</h2>
<h3 id="21">2.1 æ¶æ„æ€»è§ˆï¼šæ´‹è‘±æ¨¡å‹</h3>
<p>åœ¨å¼•å…¥ DSL åï¼ŒAgent çš„æ¶æ„å°†å‘ˆç°å‡ºæ¸…æ™°çš„åˆ†å±‚ç»“æ„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="nb">+-------------------------------------------------------+</span>
<span class="c">|  Layer 1: Business Logic (The Script)                 |</span>
<span class="c">|  </span><span class="nb">-</span><span class="c"> &quot;Pure&quot; code                                        |</span>
<span class="c">|  </span><span class="nb">-</span><span class="c"> Describes WHAT to do using DSL interfaces          |</span>
<span class="c">|  </span><span class="nb">-</span><span class="c"> No dependencies on OpenAI/LangChain/AWS SDKs       |</span>
<span class="nb">+-------------------------------------------------------+</span>
<span class="c">           |                   |                   |</span>
<span class="c">    (uses Chat Algebra) (uses Mem Algebra)  (uses Tool Algebra)</span>
<span class="c">           |                   |                   |</span>
<span class="nb">+-------------------------------------------------------+</span>
<span class="c">|  Layer 2: The DSL Definition (The Vocabulary)         |</span>
<span class="c">|  </span><span class="nb">-</span><span class="c"> Interfaces / Typeclasses / Data Structures         |</span>
<span class="c">|  </span><span class="nb">-</span><span class="c"> Defines types: ChatReq</span><span class="nt">,</span><span class="c"> ChatResp</span><span class="nt">,</span><span class="c"> KVGet</span><span class="nt">,</span><span class="c"> KVPut     |</span>
<span class="nb">+-------------------------------------------------------+</span>
<span class="c">           |                   |                   |</span>
<span class="c">    (interpreted by)    (interpreted by)    (interpreted by)</span>
<span class="c">           |                   |                   |</span>
<span class="nb">+-------------------------------------------------------+</span>
<span class="c">|  Layer 3: Interpreters (The Actors)                   |</span>
<span class="c">|  </span><span class="k">[</span><span class="c">Prod Interpreter</span><span class="k">]</span><span class="c">  </span><span class="k">[</span><span class="c">Test Interpreter</span><span class="k">]</span><span class="c">  </span><span class="k">[</span><span class="c">Replay Int</span><span class="k">]</span><span class="c"> |</span>
<span class="c">|  </span><span class="nb">-</span><span class="c"> Calls OpenAI      </span><span class="nb">-</span><span class="c"> Returns Strings   </span><span class="nb">-</span><span class="c"> Reads File |</span>
<span class="c">|  </span><span class="nb">-</span><span class="c"> Connects Redis    </span><span class="nb">-</span><span class="c"> Uses HashMap      </span><span class="nb">-</span><span class="c"> Deterministic|</span>
<span class="nb">+-------------------------------------------------------+</span>
</code></pre></div>

<h3 id="22-defining-the-algebras">2.2 æ ¸å¿ƒä»£æ•°å®šä¹‰ (Defining the Algebras)</h3>
<p>æˆ‘ä»¬éœ€è¦å°† Agent äº¤äº’ä¸–ç•Œçš„è§¦è§’ä¸€ä¸€æ–©æ–­ï¼Œç”¨æŠ½è±¡æ¥å£æ¥ç®¡ã€‚ä»¥ä¸‹æ˜¯æ ‡å‡†çš„ Agent èƒ½åŠ›é›†ï¼š</p>
<h4 id="221-llm-chat">2.2.1 è®¤çŸ¥ä»£æ•°ï¼š<code>LLM</code> / <code>Chat</code></h4>
<p>è¿™æ˜¯æœ€å¤æ‚çš„ Effectã€‚ä¸è¦ä»…ä»…ä¼ é€’ Stringï¼Œè¦ä¼ é€’è¯­ä¹‰ç»“æ„ã€‚</p>
<ul>
<li><strong>æ“ä½œå®šä¹‰</strong>ï¼š</li>
<li><code>chat(messages: List[Message], config: Config) -&gt; m Response</code></li>
<li>
<p><code>stream(messages: List[Message]) -&gt; m (Stream Response)</code> (æµå¼)</p>
</li>
<li>
<p><strong>å…³é”®æŠ½è±¡</strong>ï¼š</p>
</li>
<li><strong>Model Agnostic</strong>ï¼šè¾“å…¥è¾“å‡ºç»“æ„åº”å±è”½ <code>gpt-4</code> å’Œ <code>claude-3</code> å·®å¼‚ï¼ˆä¾‹å¦‚ï¼Œç»Ÿä¸€å°† <code>function_call</code> å’Œ <code>tool_use</code> æ˜ å°„ä¸ºæ ‡å‡†çš„ <code>ToolInvocation</code> å¯¹è±¡ï¼‰ã€‚</li>
<li><strong>Cost Awareness</strong>ï¼šè¿”å›å€¼åº”åŒ…å« <code>Usage(prompt_tokens, completion_tokens)</code>ï¼Œä»¥ä¾¿ä¸­é—´ä»¶è®¡ç®—æˆæœ¬ã€‚</li>
</ul>
<h4 id="222-tools">2.2.2 è¡Œä¸ºä»£æ•°ï¼š<code>Tools</code></h4>
<p>Agent é€šè¿‡å·¥å…·æ”¹å˜ä¸–ç•Œã€‚</p>
<ul>
<li><strong>æ“ä½œå®šä¹‰</strong>ï¼š</li>
<li><code>call(tool_name: String, args: Json) -&gt; m Json</code></li>
<li>
<p><code>list_tools() -&gt; m List[ToolSchema]</code></p>
</li>
<li>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦ list?</strong>ï¼šAgent æœ‰æ—¶éœ€è¦æ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€â€œçœ‹åˆ°â€æœ‰å“ªäº›å·¥å…·å¯ç”¨ï¼ˆä¾‹å¦‚ï¼Œæ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤å·¥å…·ï¼‰ã€‚</p>
</li>
</ul>
<h4 id="223-memory">2.2.3 çŠ¶æ€ä»£æ•°ï¼š<code>Memory</code></h4>
<p>åˆ†ä¸ºçŸ­æœŸï¼ˆä¼šè¯ï¼‰å’Œé•¿æœŸï¼ˆçŸ¥è¯†åº“ï¼‰ã€‚</p>
<ul>
<li><strong>KV Store (Short-term)</strong>: <code>get(key)</code>, <code>put(key, value, ttl)</code></li>
<li><strong>Vector Store (Long-term)</strong>: <code>search(vector, top_k, threshold) -&gt; m List[Doc]</code></li>
<li><strong>æ³¨æ„</strong>ï¼š<code>Embedding</code> è®¡ç®—é€šå¸¸ä¹Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Effectï¼ˆ<code>Embed : String -&gt; m Vector</code>ï¼‰ï¼Œå› ä¸ºå®ƒæ¶‰åŠ API è°ƒç”¨å’Œè´¹ç”¨ã€‚</li>
</ul>
<h4 id="224-system">2.2.4 ç¯å¢ƒä»£æ•°ï¼š<code>System</code> (éšå½¢çš„å…³é”®)</h4>
<p>è¿™æ˜¯å¤§å¤šæ•°å·¥ç¨‹å¸ˆç•¥çš„åœ°æ–¹ã€‚ä¸ºäº†å®ç° 100% çš„å¯å¤ç°æ€§ï¼ˆReplayabilityï¼‰ï¼Œ<strong>æ‰€æœ‰çš„éç¡®å®šæ€§æ¥æºå¿…é¡»è¢«æ‰˜ç®¡</strong>ã€‚</p>
<ul>
<li><strong>Clock</strong>: <code>now() -&gt; m Timestamp</code>ã€‚</li>
<li>
<p><em>ç”¨é€”</em>ï¼šåœ¨æµ‹è¯•ä¸­ï¼Œä½ å¯ä»¥å†»ç»“æ—¶é—´ï¼Œæˆ–è€…è®©æ—¶é—´å¿«è¿›ï¼Œæµ‹è¯• <code>TTL</code> è¿‡æœŸé€»è¾‘ã€‚</p>
</li>
<li>
<p><strong>Random</strong>: <code>uuid() -&gt; m String</code>, <code>nextInt(min, max) -&gt; m Int</code>, <code>shuffle(list) -&gt; m List</code>ã€‚</p>
</li>
<li><em>ç”¨é€”</em>ï¼šAgent çš„â€œæ¢ç´¢/åˆ©ç”¨â€ç­–ç•¥ã€ID ç”Ÿæˆã€é‡è¯•æŠ–åŠ¨ï¼ˆJitterï¼‰éƒ½éœ€è¦éšæœºæ•°ã€‚å¦‚æœç›´æ¥è°ƒ <code>Math.random()</code>ï¼Œä½ å°±æ— æ³•å›æ”¾ä¸€æ¬¡ç‰¹å®šçš„å¤±è´¥ã€‚</li>
</ul>
<h4 id="225-telemetry">2.2.5 è§‚æµ‹ä»£æ•°ï¼š<code>Telemetry</code></h4>
<p>æ—¥å¿—å’Œè¿½è¸ªä¸åº”æ˜¯ä»£ç é‡Œçš„ <code>print</code> è¯­å¥ï¼Œè€Œæ˜¯ç»“æ„åŒ–çš„ Effectã€‚</p>
<ul>
<li><strong>Trace</strong>: <code>span(name, attributes) { inner_logic } -&gt; m Result</code></li>
<li><strong>Metric</strong>: <code>counter(name, value)</code>, <code>gauge(name, value)</code></li>
</ul>
<h3 id="23-free-monad-vs-final-tagless">2.3 ä¸¤ç§æµæ´¾ï¼šFree Monad vs. Final Tagless</h3>
<p>å¦‚ä½•å®ç°ä¸Šè¿° DSLï¼Ÿå·¥ç¨‹ç•Œä¸»è¦æœ‰ä¸¤ç§é€‰æ‹©ã€‚</p>
<p>| ç‰¹æ€§ | Free Monad (Reified AST) | Final Tagless (Abstract Interface) |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Free Monad (Reified AST)</th>
<th>Final Tagless (Abstract Interface)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ ¸å¿ƒéš</strong></td>
<td><strong>è´­ç‰©æ¸…å•</strong>ã€‚ä½ æŠŠè¦ä¹°çš„ä¸œè¥¿å†™åœ¨çº¸ä¸Šï¼ˆæ„å»ºæ•°æ®ç»“æ„ï¼‰ï¼Œç„¶åäº¤ç»™è·‘è…¿çš„äººå»ä¹°ï¼ˆè§£é‡Šå™¨ï¼‰ã€‚</td>
<td><strong>ä¾èµ–æ³¨å…¥</strong>ã€‚ä½ å‘Šè¯‰å‡½æ•°ä½ éœ€è¦â€œä¼šä¹°ä¸œè¥¿çš„äººâ€ï¼ˆæ¥å£çº¦æŸï¼‰ï¼Œç¼–è¯‘å™¨æ³¨å…¥å…·ä½“çš„å®ç°å¯¹è±¡ã€‚</td>
</tr>
<tr>
<td><strong>ä»£ç è¡¨ç°</strong></td>
<td>é€’å½’çš„æ•°æ®ç±»å‹ï¼ˆTreeï¼‰ã€‚ç¨‹åºæ˜¯ä¸€ä¸ªå€¼ã€‚</td>
<td>å¸¦æ³›å‹çº¦æŸçš„å‡½æ•°ï¼š<code>def run[F[_]: Chat: Tool](...)</code></td>
</tr>
<tr>
<td><strong>è‡ªçœèƒ½åŠ›</strong></td>
<td><strong>æå¼º</strong>ã€‚ä½ å¯ä»¥åœ¨è¿è¡Œå‰éå†æ•´æ£µæ ‘ï¼Œç»Ÿè®¡å°†ä¼šè°ƒç”¨å‡ æ¬¡ APIï¼Œæˆ–è€…ä¼˜åŒ–æ‰§è¡Œé¡ºåºã€‚</td>
<td><strong>å¼±</strong>ã€‚ä»£ç ç¼–è¯‘æˆäº†å‡½æ•°è°ƒç”¨ï¼Œè¿è¡Œæ—¶å¾ˆéš¾â€œé¢„çŸ¥â€åç»­æ­¥éª¤ã€‚</td>
</tr>
<tr>
<td><strong>æ€§èƒ½</strong></td>
<td>è¾ƒæ…¢ã€‚æ¯ä¸€æ­¥éƒ½éœ€è¦æ„å»ºå¯¹è±¡å’Œéå†ã€‚</td>
<td>æå¿«ã€‚é€šå¸¸å†…è”ä¸ºç›´æ¥çš„æ–¹æ³•è°ƒç”¨ã€‚</td>
</tr>
<tr>
<td><strong>é€‚ç”¨è¯­è¨€</strong></td>
<td>Haskell, Scala (Cats/Zio), TypeScript (fp-ts)</td>
<td>Scala, Java, C#, TypeScript (Interface)</td>
</tr>
<tr>
<td><strong>æ¨èåœºæ™¯</strong></td>
<td>éœ€è¦å¯¹ç¨‹åºè¿›è¡Œæ·±åº¦é™æ€åˆ†æã€ä¼˜åŒ–æˆ–åºåˆ—åŒ–ä¼ è¾“æ—¶ã€‚</td>
<td><strong>ç»å¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒ Agent</strong>ã€‚ç®€å•ã€é«˜æ•ˆã€æ˜“æ‡‚ã€‚</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Rule of Thumb</strong>ï¼šé™¤éä½ åœ¨å†™ä¸€ä¸ªéœ€è¦â€œåºåˆ—åŒ– Agent æ‰§è¡Œè®¡åˆ’å¹¶å‘ç»™å¦ä¸€å°æœºå™¨è¿è¡Œâ€çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¦åˆ™ä¼˜å…ˆé€‰æ‹© <strong>Final Tagless (Interface pattern)</strong>ã€‚å®ƒæ›´ç¬¦åˆä¸»æµå·¥ç¨‹ç›´è§‰ã€‚</p>
</blockquote>
<h3 id="24-the-power-of-interpreters">2.4 è§£é‡Šå™¨çš„é­”åŠ› (The Power of Interpreters)</h3>
<p>ä¸€æ—¦æˆ‘ä»¬ä»˜å‡ºäº†â€œå®šä¹‰ DSLâ€çš„ä»£ä»·ï¼Œæˆ‘ä»¬å°†æ”¶è·å·¨å¤§çš„çµæ´»æ€§ã€‚æˆ‘ä»¬å¯ä»¥ç¼–å†™å¤šç§è§£é‡Šå™¨æ¥åº”å¯¹ä¸åŒåœºæ™¯ï¼š</p>
<ol>
<li>
<p><strong>Production Interpreter</strong>ï¼š
* è¿æ¥çœŸå®çš„ <code>OpenAI</code> APIã€‚
* è¿æ¥çœŸå®çš„ <code>Redis</code> / <code>Pinecone</code>ã€‚
* ä½¿ç”¨ç³»ç»Ÿæ—¶é’Ÿã€‚</p>
</li>
<li>
<p><strong>Mock Interpreter (Unit Test)</strong>ï¼š
* <code>Chat</code>: æ°¸è¿œè¿”å› "Hello World" æˆ–æ ¹æ® Prompt å…³é”®è¯åŒ¹é…è¿”å›ã€‚
* <code>Memory</code>: ä½¿ç”¨å†…å­˜ <code>Map</code> æ¨¡æ‹Ÿæ•°æ®åº“ã€‚
* <code>Clock</code>: æ—¶é—´æ°¸è¿œåœåœ¨ <code>2024-01-01</code>ã€‚
* <strong>ä»·å€¼</strong>ï¼šæ¯«ç§’çº§è¿è¡Œæ•´ä¸ªå¯¹è¯æµç¨‹æµ‹è¯•ï¼Œé›¶æˆæœ¬ã€‚</p>
</li>
<li>
<p><strong>Record/Replay Interpreter (Integration Test / Debug)</strong>ï¼š
* <strong>Record æ¨¡å¼</strong>ï¼šä½œä¸º Production çš„ä»£ç†ã€‚è¿è¡Œæ—¶ï¼Œè®¡ç®— <code>Hash(Input)</code>ï¼Œå°† <code>(Input, Output)</code> åºåˆ—åŒ–å­˜å…¥ JSON æ–‡ä»¶ï¼ˆTapeï¼‰ã€‚
* <strong>Replay æ¨¡å¼</strong>ï¼šé€šè¿‡è®¡ç®— <code>Hash(Input)</code> ä» JSON æ–‡ä»¶ä¸­æŸ¥æ‰¾ Responseã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼ŒæŠ¥é”™ã€‚
* <strong>ä»·å€¼</strong>ï¼šæ•è·ä¸€æ¬¡çº¿ä¸Šå‡ºç°çš„å¤æ‚ Bugï¼ˆä¾‹å¦‚ 10 è½®å¯¹è¯åçš„é€»è¾‘é”™è¯¯ï¼‰ï¼Œå°†å…¶å›ºåŒ–ä¸ºæµ‹è¯•ç”¨ä¾‹ï¼Œåœ¨æœ¬åœ°åå¤è°ƒè¯•ç›´åˆ°ä¿®å¤ã€‚</p>
</li>
<li>
<p><strong>Human-in-the-Loop Interpreter</strong>ï¼š
* å¯¹äº <code>Tool.call("delete_database")</code> è¿™æ ·çš„é«˜å±æ“ä½œï¼Œè§£é‡Šå™¨å¯ä»¥æ‹¦æˆªæ‰§è¡Œï¼Œé€šè¿‡ Slack/Email å‘é€å®¡æ‰¹è¯·æ±‚ï¼Œç­‰å¾…äººç±»æ‰¹å‡†åå†æ¢å¤æ‰§è¡Œï¼ˆæˆ–æŠ›å‡ºæ‹’ç»ï¼‰ã€‚
* <strong>æ³¨æ„</strong>ï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä»£ç ä¸­ï¼Œè¿™çœ‹èµ·æ¥åªæ˜¯æ™®é€šçš„ <code>tool.call</code>ï¼Œå®¡æ‰¹æµç¨‹å®Œå…¨è¢«è§£é‡Šå™¨å°è£…äº†ã€‚</p>
</li>
</ol>
<hr />
<h2 id="3">3. æœ¬ç« å°ç»“</h2>
<ul>
<li><strong>DSL æ˜¯å¥‘çº¦</strong>ï¼šAgent ä»£ç æè¿°æ„å›¾ï¼ŒInterpreter è´Ÿè´£è½å®ã€‚</li>
<li><strong>å…¨é‡æŠ½è±¡</strong>ï¼šä¸ä»…ä»…æ˜¯ LLMï¼Œå‡¡æ˜¯æ¶‰åŠ IOã€çŠ¶æ€ã€æ—¶é—´ã€éšæœºæ€§çš„æ“ä½œï¼Œéƒ½å¿…é¡»è¿›å…¥ DSLã€‚</li>
<li><strong>Final Tagless</strong>ï¼šæ˜¯å®ç° DSL çš„ä¸€ç§è½»é‡çº§ã€é«˜æ€§èƒ½çš„å·¥ç¨‹æ¨¡å¼ï¼Œæœ¬è´¨ä¸Šæ˜¯â€œé«˜é˜¶ä¾èµ–å…¥â€ã€‚</li>
<li><strong>å¯æµ‹æ€§çº¢åˆ©</strong>ï¼šé€šè¿‡æ›´æ¢è§£é‡Šå™¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠâ€œä¸å¯æµ‹â€çš„ AI åº”ç”¨å˜æˆâ€œå®Œå…¨ç¡®å®šæ€§â€çš„è½¯ä»¶ç³»ç»Ÿã€‚</li>
<li><strong>å›æ”¾æœºåˆ¶</strong>ï¼šRecord/Replay è§£é‡Šå™¨æ˜¯è°ƒè¯•å¤æ‚ Agent è¡Œä¸ºï¼ˆå¹»è§‰ã€æ­»å¾ªç¯ï¼‰çš„ç»ˆææ­¦å™¨ã€‚</li>
</ul>
<hr />
<h2 id="4">4. ç»ƒä¹ é¢˜</h2>
<h3 id="_1">åŸºç¡€é¢˜</h3>
<p><strong>Q1. å®šä¹‰ Time Algebra</strong>
åœ¨è®¸å¤š Agent ä»»åŠ¡ä¸­ï¼ŒAgent éœ€è¦çŸ¥é“â€œä»Šå¤©æ˜¯æ˜ŸæœŸå‡ â€æ¥å†³å®šæ˜¯å¦å‘é€å·¥ä½œé‚®ä»¶ã€‚
è¯·å®šä¹‰ä¸€ä¸ªç®€å•çš„ <code>Clock</code> èƒ½åŠ›æ¥å£ï¼ˆå¯ä»¥ç”¨ä¼ªä»£ç æˆ– TypeScript æ¥å£ï¼‰ï¼Œå¹¶ç»™å‡ºå…¶ Production å®ç°å’Œ Test å®ç°ã€‚</p>
<details>
<summary>ç‚¹å‡»å±•å¼€ç­”æ¡ˆ</summary>
<p><strong>Hints</strong>:
Production ä½¿ç”¨ <code>Date.now()</code>ï¼ŒTest ä½¿ç”¨ä¸€ä¸ªå¯å˜çš„å˜é‡ã€‚</p>
<p><strong>Answer (TypeScript é£æ ¼)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 1. Algebra (Interface)</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">Clock</span><span class="o">&lt;</span><span class="nx">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">now</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">F</span><span class="o">&lt;</span><span class="nb">Date</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 2. Production Implementation (IO based)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">prodClock</span><span class="o">:</span><span class="w"> </span><span class="kt">Clock</span><span class="o">&lt;</span><span class="nx">IO</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">now</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">IO</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">())</span>
<span class="p">};</span>

<span class="c1">// 3. Test Implementation (State based)</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">MockClock</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">Clock</span><span class="o">&lt;</span><span class="nx">Identity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">_currentTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_currentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">start</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// å…è®¸æµ‹è¯•ä»£ç æ¨è¿›æ—¶é—´</span>
<span class="w">  </span><span class="nx">advance</span><span class="p">(</span><span class="nx">ms</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_currentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_currentTime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ms</span><span class="p">);</span><span class="w"> </span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_currentTime</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>
<p><strong>Q2. è¯†åˆ«éšå¼ä¾èµ–</strong>
å®¡æŸ¥ä»¥ä¸‹ä»£ç ï¼Œæ‰¾å‡ºæ‰€æœ‰ç ´åâ€œçº¯æ´æ€§â€ä¸”éœ€è¦è¢«æŠ½è±¡è¿› DSL çš„ç‚¹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">decide_action</span><span class="p">(</span><span class="n">user_input</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User said: </span><span class="si">{</span><span class="n">user_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>           <span class="c1"># 1</span>
    <span class="k">if</span> <span class="s2">&quot;urgent&quot;</span> <span class="ow">in</span> <span class="n">user_input</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;call_human&quot;</span>

    <span class="kn">import</span> <span class="nn">uuid</span>
    <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>              <span class="c1"># 2</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># assume db is a global object</span>
        <span class="n">last_seen</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_input</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>  <span class="c1"># 3</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;error&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;process&quot;</span>
</code></pre></div>

<details>
<summary>ç‚¹å‡»å±•å¼€ç­”æ¡ˆ</summary>
<p><strong>Answer</strong>:</p>
<ol>
<li><code>print(...)</code>: æ ‡å‡†è¾“å‡ºå‰¯ä½œç”¨ã€‚åº”æŠ½è±¡ä¸º <code>Logger.info(...)</code>ã€‚</li>
<li><code>uuid.uuid4()</code>: éšæœºæ€§æ¥æºã€‚ä¸å¯å¤ç°ã€‚åº”æŠ½è±¡ä¸º <code>UUIDGen.generate()</code>ã€‚</li>
<li><code>db.get(...)</code>: å¤–éƒ¨ IO ä¸”ä¾èµ–å…¨å±€å˜é‡ã€‚åº”æŠ½è±¡ä¸º <code>KVStore.get(...)</code>ã€‚</li>
</ol>
</details>
<p><strong>Q3. è§£é‡Šå™¨è·¯ç”±</strong>
å‡è®¾ä½ çš„ Agent éœ€è¦åŒæ—¶ä½¿ç”¨ GPT-4 å¤„ç†å¤æ‚é€»è¾‘ï¼Œä½¿ç”¨ Haiku å¤„ç†ç®€å•æ€»ç»“ã€‚ä½ åº”è¯¥å¦‚ä½•åœ¨ DSL ä¸­è¡¨è¾¾è¿™ç§éœ€æ±‚ï¼Ÿ</p>
<details>
<summary>ç‚¹å‡»å±•å¼€ç­”æ¡ˆ</summary>
<p><strong>Answer</strong>:
ä¸è¦åœ¨ DSL ä¸­ç¡¬ç¼–ç æ¨¡å‹åã€‚
<strong>æ–¹æ³• A (å¤šä»£æ•°)</strong>ï¼šå®šä¹‰ä¸¤ä¸ªèƒ½åŠ› <code>SmartChat</code> å’Œ <code>FastChat</code>ã€‚
<strong>æ–¹æ³• B (å‚æ•°åŒ–)</strong>ï¼šåœ¨ <code>chat</code> æ–¹æ³•ä¸­æ¥å—ä¸€ä¸ªæŠ½è±¡çš„ <code>ModelTier</code> æšä¸¾ï¼ˆHigh/Low/Economyï¼‰ï¼Œç”±è§£é‡Šå™¨å†³å®š <code>High</code> æ˜ å°„åˆ° GPT-4ï¼Œ<code>Low</code> æ˜ å°„åˆ° Haikuã€‚æ¨èæ–¹æ³• Bï¼Œå› ä¸ºæ›´æ˜“äºé…ç½®åˆ‡æ¢ã€‚</p>
</details>
<h3 id="_2">æŒ‘æˆ˜é¢˜</h3>
<p><strong>Q4. è®¾è®¡â€œå½•åˆ¶/å›æ”¾â€çš„æ•°æ®ç»“æ„</strong>
è®¾è®¡ä¸€ä¸ª JSON ç»“æ„ï¼ˆTapeï¼‰ï¼Œç”¨äºå­˜å‚¨ä¸€æ¬¡ Agent æ‰§è¡Œçš„æ‰€æœ‰ Effectã€‚
è€ƒè™‘ï¼šå¦‚æœ Agent å¹¶å‘æ‰§è¡Œäº†ä¸¤ä¸ª HTTP è¯·æ±‚ï¼Œå¦‚ä½•ç¡®ä¿å›æ”¾æ—¶åŒ¹é…åˆ°æ­£ç¡®çš„å“åº”ï¼Ÿ</p>
<details>
<summary>ç‚¹å‡»å±•å¼€ç­”æ¡ˆ</summary>
<p><strong>Hints</strong>:
ä»…é é¡ºåºåŒ¹é…åœ¨å¹¶å‘åœºæ™¯ä¸‹æ˜¯ä¸å¯é çš„ã€‚éœ€è¦æŒ‡çº¹ï¼ˆFingerprint/Hashï¼‰ã€‚</p>
<p><strong>Answer Sketch</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;trace_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abc-123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;interactions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;effect_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Chat&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;input_hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256(messages + config)&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;input_raw&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">},</span><span class="w"> </span>
<span class="w">      </span><span class="nt">&quot;output&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;usage&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1715000000</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;effect_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Tool&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;tool_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;search&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;args_hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256(query=&#39;test&#39;)&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;output&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><em>å¹¶å‘åŒ¹é…ç­–ç•¥</em>ï¼š
åœ¨å›æ”¾æ—¶ï¼Œé€šå¸¸ä¸ä¾èµ–é¡ºåºï¼Œè€Œæ˜¯æ„å»ºä¸€ä¸ª <code>Map&lt;Hash, Queue&lt;Output&gt;&gt;</code>ã€‚
å½“ DSL è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œè®¡ç®—è¯·æ±‚çš„ Hashï¼Œä»å¯¹åº”çš„é˜Ÿåˆ—ä¸­ <code>pop</code> å‡ºä¸€ä¸ªé¢„å½•åˆ¶çš„å“åº”ã€‚</p>
</details>
<p><strong>Q5. çº¯å‡½æ•°å¼â€œé‡è¯•â€ä¸­é—´ä»¶</strong>
åœ¨ä¸ä¿®æ”¹ <code>Chat</code> æ¥å£å®šä¹‰ï¼Œä¹Ÿä¸ä¿®æ”¹ <code>OpenAIInterpreter</code> ä»£ç çš„å‰æä¸‹ï¼Œå¦‚ä½•åˆ©ç”¨ DSL çš„ç»„åˆæ€§ï¼Œä¸º <code>Chat</code> èƒ½åŠ›å¢åŠ â€œå¤±è´¥è‡ªåŠ¨é‡è¯• 3 æ¬¡â€çš„åŠŸèƒ½ï¼Ÿ</p>
<details>
<summary>ç‚¹å‡»å±•å¼€ç­”æ¡ˆ</summary>
<p><strong>Answer</strong>:
ä½¿ç”¨<strong>è£…é¥°å™¨æ¨¡å¼ï¼ˆDecoratorï¼‰æˆ–é«˜é˜¶è§£é‡Šå™¨</strong>ã€‚
ç¼–å†™ä¸€ä¸ªæ–°çš„è§£é‡Šå™¨ <code>RetryingChatInterpreter</code>ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªåŸºç¡€çš„ <code>ChatInterpreter</code>ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">retryingChat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">base</span><span class="o">:</span><span class="w"> </span><span class="kt">Chat</span><span class="p">,</span><span class="w"> </span><span class="nx">policy</span><span class="o">:</span><span class="w"> </span><span class="kt">RetryPolicy</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">Chat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">  </span><span class="nx">chat</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ä¼ªä»£ç ï¼šåˆ©ç”¨ Monad çš„é€’å½’æˆ– retry ç»„åˆå­</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">retry</span><span class="p">(</span><span class="nx">policy</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">base</span><span class="p">.</span><span class="nx">chat</span><span class="p">(</span><span class="nx">req</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</code></pre></div>

<p>è¿™è¯æ˜äº† Effect æŠ½è±¡çš„å¼ºå¤§ä¹‹å¤„ï¼šæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚é‡è¯•ã€é™æµã€ç¼“å­˜ï¼‰å¯ä»¥ä½œä¸ºç‹¬ç«‹çš„å±‚å åŠ åœ¨æ ¸å¿ƒé€»è¾‘ä¹‹ä¸Šã€‚</p>
</details>
<hr />
<h2 id="5-gotchas">5. å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="51-leaky-abstractions">5.1 æŠ½è±¡æ³„æ¼ (Leaky Abstractions)</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šä½ çš„ DSL æ¥å£ä¸­å‡ºç°äº† <code>import { ChatCompletionChunk } from 'openai'</code>ã€‚</li>
<li><strong>é—®é¢˜</strong>ï¼šè¿™ä½¿å¾— DSL ç»‘å®šåˆ°äº†ç‰¹å®šçš„ SDKã€‚å¦‚æœ OpenAI æ›´æ–°äº† SDK ç‰ˆæœ¬æˆ–è€…ä½ æƒ³æ¢ SDKï¼Œæ¥å£å°±å¾—å˜ã€‚</li>
<li><strong>å¯¹ç­–</strong>ï¼šå®šä¹‰è‡ªå·±çš„ DTO (Data Transfer Objects)ã€‚è™½ç„¶å†™è½¬æ¢ä»£ç å¾ˆç¹çï¼Œä½†ä¸ºäº†æ¶æ„çš„æ•´æ´æ˜¯å€¼å¾—çš„ã€‚</li>
</ul>
<h3 id="52">5.2 åªæœ‰å‰¯ä½œç”¨ï¼Œæ²¡æœ‰è¿”å›å€¼</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼š<code>log(msg: String) -&gt; m Unit</code>ã€‚</li>
<li><strong>é—®é¢˜</strong>ï¼šçœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œä½ å¯èƒ½éœ€è¦ç­‰å¾…æ—¥å¿—å†™å…¥å®Œæˆå†ç»ˆæ­¢ç¨‹åºï¼Œæˆ–è€…éœ€è¦æ•è·æ—¥å¿—ç³»ç»Ÿçš„ç£ç›˜æ»¡é”™è¯¯ã€‚</li>
<li><strong>å¯¹ç­–</strong>ï¼šå³ä½¿æ˜¯ <code>Unit</code> è¿”å›å€¼ï¼Œä¹Ÿè¦ç¡®ä¿å®ƒæ˜¯åŒ…è£¹åœ¨ <code>m</code> (Effect) ä¸­çš„ï¼Œå¹¶ä¸”è¦è€ƒè™‘æ˜¯å¦éœ€è¦è¿”å›ä¸€ä¸ª <code>Handle</code> æˆ– <code>Result</code>ã€‚</li>
</ul>
<h3 id="53">5.3 æ··æ·†â€œé…ç½®â€ä¸â€œä¸Šä¸‹æ–‡â€</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šæŠŠ <code>UserID</code> æˆ– <code>SessionID</code> ä½œä¸º <code>Chat</code> è§£é‡Šå™¨çš„åˆå§‹åŒ–å‚æ•°ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è°ƒç”¨çš„å‚æ•°ã€‚</li>
<li><strong>é—®é¢˜</strong>ï¼šè¿™æ„å‘³ç€ä½ çš„è§£é‡Šå™¨æ˜¯æœ‰çŠ¶æ€çš„ï¼ˆStatefulï¼‰ï¼Œéš¾ä»¥åœ¨å¤šç”¨æˆ·å¹¶å‘ç¯å¢ƒä¸‹å¤ç”¨åŒä¸€ä¸ªè§£é‡Šå™¨å®ä¾‹ã€‚</li>
<li><strong>å¯¹ç­–</strong>ï¼šè§£é‡Šå™¨åº”è¯¥æ˜¯æ— çŠ¶æ€çš„å•ä¾‹ã€‚<code>UserID</code> åº”è¯¥é€šè¿‡ <code>Reader</code> Monad ä¼ é€’ï¼Œæˆ–è€…ä½œä¸º DSL æ–¹æ³•çš„ä¸€ä¸ªæ˜¾å¼å‚æ•°ï¼ˆContext Objectï¼‰ã€‚</li>
</ul>
<h3 id="54-effect">5.4 æ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯ Effectï¼Ÿ</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šæŠŠ <code>JSON.parse</code> æˆ– <code>String.split</code> ä¹Ÿåšæˆ Effectã€‚</li>
<li><strong>é—®é¢˜</strong>ï¼šè¿‡åº¦å·¥ç¨‹ã€‚</li>
<li><strong>Rule of Thumb</strong>ï¼š
1. <strong>çº¯è®¡ç®—</strong>ï¼ˆç›¸åŒçš„è¾“å…¥æ°¸è¿œå¾—åˆ°ç›¸åŒçš„è¾“å‡ºï¼Œä¸”æ— å‰¯ä½œç”¨ï¼‰ -&gt; <strong>ä¸éœ€è¦ Effect</strong>ï¼Œç›´æ¥å†™å‡½æ•°ã€‚
2. <strong>ä¸ç¡®å®šæ€§/å‰¯ä½œç”¨</strong> -&gt; <strong>å¿…é¡»æ˜¯ Effect</strong>ã€‚</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter3.html" class="nav-link prev">â† Chapter 3 â€” Kleisli Arrowï¼šæŠŠâ€œå¸¦ IO çš„å‡½æ•°â€å½“ä½œå¯ç»„åˆç®­å¤´</a><a href="chapter5.html" class="nav-link next">Chapter 5 â€” Runtime ä¸è°ƒåº¦ï¼šä»è§£é‡Šå™¨åˆ°å¹¶å‘ã€å–æ¶ˆä¸èµ„æºç®¡ç† (chapter5.md) â†’</a></nav>
        </main>
    </div>
</body>
</html>