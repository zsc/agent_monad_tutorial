<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>Chapter 3 â€” Kleisli Arrowï¼šæŠŠâ€œå¸¦ IO çš„å‡½æ•°â€å½“ä½œå¯ç»„åˆç®­å¤´</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ã€Šç”¨ IO Monad æ­å»º LLM Agentï¼šä» Kleisli åˆ°äº‹ä»¶å»ºæ¨¡ä¸ FRPã€‹ç›®å½•ï¼ˆindex.mdï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 1 â€” LLM Agent çš„â€œæŠ½è±¡è¾¹ç•Œâ€ï¼šä¸ºä»€ä¹ˆä» IO Monad å‡ºå‘</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 2 â€” IO Monad é€Ÿæˆï¼šä»æ¦‚å¿µåˆ°å·¥ç¨‹å®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 3 â€” Kleisli Arrowï¼šæŠŠâ€œå¸¦ IO çš„å‡½æ•°â€å½“ä½œå¯ç»„åˆç®­å¤´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 4 â€” Agent DSLï¼šæŠŠå·¥å…·ã€è®°å¿†ä¸æ§åˆ¶æµåšæˆâ€œå¯è§£é‡Šçš„ effectâ€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 5 â€” Runtime ä¸è°ƒåº¦ï¼šä»è§£é‡Šå™¨åˆ°å¹¶å‘ã€å–æ¶ˆä¸èµ„æºç®¡ç† (chapter5.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 6 â€” äº‹ä»¶å»ºæ¨¡ï¼šIO timeoutã€é‡è¯•ã€é€€é¿ã€ç†”æ–­ä¸é¢„ç®—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 7 â€” Coding Agent çš„ Loop Detectionï¼šè®© Agent å¯ç»ˆæ­¢ã€å¯è§£é‡Š</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 8 â€” A/B Test ä¸è¯„ä¼°ï¼šæŠŠå®éªŒåµŒè¿› IO/Kleisli ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 9 â€” å¯è§‚æµ‹æ€§ï¼šTrace/Spanã€æ—¥å¿—ã€æŒ‡æ ‡ä¸å¯å¤ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 10 â€” ä¸ FRP çš„å…³ç³»ï¼šå½“ Agent å˜æˆâ€œäº‹ä»¶æµå¤„ç†å™¨â€ (chapter10.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 11 â€” ç»¼åˆæ¡ˆä¾‹ï¼šå®ç°ä¸€ä¸ªå¯æ’æ‹”çš„ Coding Agent (chapter11.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 12 â€” æ‰©å±•é˜…è¯»ä¸è·¯çº¿å›¾ï¼šé€šå¾€ç±»å‹å®‰å…¨ä¸ç”Ÿäº§ç¯å¢ƒçš„å½¼å²¸</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 13 â€” é™„å½•ï¼šç»ˆæå‚è€ƒæ‰‹å†Œ (The Ultimate Reference)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 14 â€” Search API + RAGï¼šæ„å»ºæ£€ç´¢å¢å¼ºçš„ RAG Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="chapter-3-kleisli-arrow-io">Chapter 3 â€” Kleisli Arrowï¼šæŠŠâ€œå¸¦ IO çš„å‡½æ•°â€å½“ä½œå¯ç»„åˆç®­å¤´</h1>
<h2 id="1-agent">1. å¼€ç¯‡æ®µè½ï¼šAgent å¼€å‘ä¸­çš„â€œèƒ¶æ°´å±æœºâ€</h2>
<p>åœ¨æ„å»º LLM Agent æ—¶ï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šæ˜¯åœ¨ç¼–æ’ä¸€ç³»åˆ—<strong>ä¸ç¡®å®š</strong>ä¸”<strong>æœ‰å‰¯ä½œç”¨</strong>çš„æ“ä½œï¼š</p>
<ul>
<li>ç”¨æˆ·è¾“å…¥  æ£€ç´¢å‘é‡åº“ï¼ˆå¯èƒ½å¤±è´¥ã€ç½‘ç»œå»¶è¿Ÿï¼‰</li>
<li>æ„å»º Prompt  è°ƒç”¨ LLMï¼ˆè€—æ—¶ã€å¯èƒ½è¶…æ—¶ã€è¿”å›ä¹±ç ï¼‰</li>
<li>è§£æç»“æœ  æ‰§è¡Œå·¥å…·ï¼ˆæ–‡ä»¶è¯»å†™ã€API è°ƒç”¨ï¼‰</li>
</ul>
<p>åœ¨ä¼ ç»Ÿçš„å‘½ä»¤å¼ç¼–ç¨‹ï¼ˆImperative Programmingï¼‰ä¸­ï¼Œè¿™ç§æµç¨‹é€šå¸¸é•¿è¿™æ ·ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å…¸å‹çš„ &quot;Spaghetti Code&quot; Agent</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">run_agent</span><span class="p">(</span><span class="n">user_input</span><span class="p">):</span>
    <span class="c1"># 1. æ£€ç´¢</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="k">await</span> <span class="n">vector_db</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">DbError</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># å®¹é”™é€»è¾‘æ··åœ¨ä¸»æµç¨‹é‡Œ</span>

    <span class="c1"># 2. æ„é€  Prompt (çº¯é€»è¾‘)</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n</span><span class="s2">Question: </span><span class="si">{</span><span class="n">user_input</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># 3. LLM è°ƒç”¨</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">llm_client</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span> 
        <span class="k">return</span> <span class="s2">&quot;Error: Empty response&quot;</span> <span class="c1"># é”™è¯¯æ£€æŸ¥</span>

    <span class="c1"># 4. è§£æä¸æ‰§è¡Œ</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;tool&gt;&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">parse_tool</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exec_tool</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="c1"># åˆæ˜¯ IO</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
</code></pre></div>

<p>è¿™æ®µä»£ç çš„é—®é¢˜åœ¨äºï¼š<strong>ä¸šåŠ¡é€»è¾‘ï¼ˆåšä»€ä¹ˆï¼‰ä¸æ§åˆ¶æµï¼ˆé”™è¯¯å¤„ç†ã€ç­‰å¾…ã€é‡è¯•ï¼‰ç´§å¯†è€¦åˆ</strong>ã€‚å¦‚æœä½ æƒ³ç»™æ¯ä¸€æ­¥éƒ½åŠ ä¸Šâ€œTracing è¿½è¸ªâ€æˆ–â€œRetry é‡è¯•â€ï¼Œä»£ç ä½“ç§¯ä¼šçˆ†ç‚¸ã€‚</p>
<p><strong>Kleisli Arrowï¼ˆå…‹è±æ–¯åˆ©ç®­å¤´ï¼‰</strong> æ˜¯å‡½æ•°å¼ç¼–ç¨‹æä¾›çš„ä¸€æŠŠæ‰‹æœ¯åˆ€ã€‚å®ƒå°†å½¢å¼ä¸º <code>a -&gt; m b</code>  çš„å‡½æ•°ï¼ˆå³â€œè¾“å…¥ aï¼Œäº§ç”Ÿå¸¦ m ä¸Šä¸‹æ–‡çš„ m bâ€ï¼‰è§†ä¸ºåŸºæœ¬çš„<strong>ç»„åˆå•å…ƒ</strong>ã€‚é€šè¿‡ Kleisli ç»„åˆï¼Œæˆ‘ä»¬å¯ä»¥åƒæ­ç§¯æœ¨ä¸€æ ·ï¼Œ Agent çš„æ€è€ƒã€è¡ŒåŠ¨ã€è§‚å¯Ÿä¸²è”æˆä¸€æ¡<strong>çº¿æ€§çš„ã€ç±»å‹å®‰å…¨çš„ã€è‡ªå¸¦é”™è¯¯å¤„ç†çš„</strong>ç®¡é“ã€‚</p>
<p><strong>æœ¬ç« å­¦ä¹ ç›®æ ‡ï¼š</strong></p>
<ol>
<li>å½»åº•ç†è§£ Kleisli Arrow çš„å®šä¹‰  ä¸æ™®é€šå‡½æ•°çš„åŒºåˆ«ã€‚</li>
<li>æŒæ¡æ ¸å¿ƒæ“ä½œç¬¦ <strong>Fish Operator (<code>&gt;=&gt;</code>)</strong> åŠå…¶åœ¨ä¸åŒè¯­è¨€ä¸­çš„å®ç°ã€‚</li>
<li>åˆ©ç”¨ Kleisli Category é‡æ„ Agentï¼šå°† Plannerã€Executorã€Memory å˜æˆå¯ç»„åˆæ¨¡å—ã€‚</li>
<li><strong>ä¸­é—´ä»¶æ¨¡å¼</strong>ï¼šå¦‚ä½•åˆ©ç”¨ Kleisli ç»„åˆåœ¨ä¸ä¿®æ”¹ä¸šåŠ¡ä»£ç çš„å‰æä¸‹ï¼Œé€æ˜åœ°æ³¨å…¥ Logã€Trace å’Œ Retryã€‚</li>
<li>è¾¨æ Kleisli ä¸ Arrow çš„åŒºåˆ«ï¼šä½•æ—¶æˆ‘ä»¬éœ€è¦å¹¶è¡Œèƒ½åŠ›ã€‚</li>
</ol>
<hr />
<h2 id="2">2. æ–‡å­—è®ºè¿°</h2>
<h3 id="21-kleisli-arrow">2.1 ä»€ä¹ˆæ˜¯ Kleisli Arrowï¼Ÿ</h3>
<p>åœ¨æ•°å­¦èŒƒç•´è®ºä¸­ï¼Œâ€œç®­å¤´â€ï¼ˆMorphismï¼‰é€šå¸¸æŒ‡çº¯å‡½æ•° ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ç»„åˆå®ƒä»¬ï¼šã€‚
ä½†åœ¨ Agent å·¥ç¨‹ä¸­ï¼Œç»å¤§å¤šæ•°å‡½æ•°æ˜¯<strong>ä¸çº¯çš„</strong>ï¼ˆEffectfulï¼‰ã€‚æˆ‘ä»¬ç§°è¿™ç±»å‡½æ•°ä¸º <strong>Kleisli Arrow</strong>ã€‚</p>
<p>å®šä¹‰ï¼šä¸€ä¸ª <strong>Kleisli Arrow</strong> æ˜¯ä¸€ä¸ªå…·æœ‰å¦‚ä¸‹ç±»å‹ç­¾åçš„å‡½æ•°ï¼š</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>a : <strong>è¾“å…¥ç±»å‹</strong>ï¼ˆInputã€‚</li>
<li>m : <strong>Monad ä¸Šä¸‹æ–‡</strong>ï¼ˆContext/Effectï¼‰ã€‚åœ¨ Agent ä¸­ï¼Œè¿™é€šå¸¸æ˜¯ <code>IO</code>ã€<code>Promise</code>ã€<code>Future</code>ï¼Œæˆ–è€…æ˜¯åŒ…å«é”™è¯¯å¤„ç†çš„ <code>IO[Either[Error, ?]]</code>ã€‚</li>
<li>b : <strong>è¾“å‡ºå€¼ç±»å‹</strong>ï¼ˆResultï¼‰ã€‚</li>
</ul>
<p><strong>Agent ç»„ä»¶ä½œä¸º Kleisli Arrow çš„æ˜ å°„ï¼š</strong></p>
<p>| Agent ç»„ä»¶ | è¾“å…¥ () | Effect () | è¾“å‡º () | å‡½æ•°ç­¾åç¤ºä¾‹ |</p>
<table>
<thead>
<tr>
<th>Agent ç»„ä»¶</th>
<th>è¾“å…¥ ()</th>
<th>Effect ()</th>
<th>è¾“å‡º ()</th>
<th>å‡½æ•°ç­¾åç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Retriever</strong></td>
<td><code>Query</code></td>
<td><code>IO</code> (ç½‘ç»œ/DB)</td>
<td><code>List[Doc]</code></td>
<td><code>search: Query -&gt; IO [Doc]</code></td>
</tr>
<tr>
<td><strong>LLM Model</strong></td>
<td><code>Prompt</code></td>
<td><code>IO</code> (ç½‘ç»œ/å»¶è¿Ÿ)</td>
<td><code>String</code></td>
<td><code>chat: Prompt -&gt; IO String</code></td>
</tr>
<tr>
<td><strong>Parser</strong></td>
<td><code>String</code></td>
<td><code>Either Error</code> (è§£æå¯èƒ½å¤±è´¥)</td>
<td><code>Action</code></td>
<td><code>parse: String -&gt; Either Err Action</code></td>
</tr>
<tr>
<td><strong>Tool</strong></td>
<td><code>Action</code></td>
<td><code>IO</code> (å‰¯ä½œç”¨)</td>
<td><code>Observation</code></td>
<td><code>run: Action -&gt; IO Observation</code></td>
</tr>
</tbody>
</table>
<h3 id="22">2.2 ç»„åˆçš„å‡ ä½•å­¦ï¼šä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Ÿ</h3>
<p>å¦‚æœæˆ‘ä»¬æœ‰ä¸¤ä¸ª Kleisli Arrowï¼š</p>
<ol>
<li>(ä¾‹å¦‚ï¼š<code>getUserInput</code>)</li>
<li>(ä¾‹å¦‚ï¼š<code>searchGoogle</code>)</li>
</ol>
<p>æˆ‘ä»¬<strong>ä¸èƒ½</strong>å†™ ã€‚
å› ä¸º  è¿”å›çš„æ˜¯ä¸€ä¸ªâ€œç›’å­â€ <code>IO B</code>ï¼Œè€Œ  éœ€è¦çš„æ˜¯ç›’å­é‡Œçš„è£¸å€¼â€ <code>B</code>ã€‚å³ç±»å‹ä¸åŒ¹é…ï¼š</p>
<p>åœ¨å‘½ä»¤å¼è¯­è¨€é‡Œï¼Œæˆ‘ä»¬ç”¨ <code>await</code> æˆ– <code>.then()</code> å¼ºè¡Œæ‹†åŒ…ã€‚ä½†åœ¨æŠ½è±¡å±‚é¢ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ“ä½œç¬¦ï¼Œèƒ½å¤Ÿè‡ªåŠ¨å®Œæˆâ€œ<strong>æ‹†åŒ… -&gt; ä¼ é€’ -&gt; å°åŒ…</strong>â€çš„è¿‡ç¨‹ã€‚</p>
<h3 id="23-the-fish-operator">2.3 The Fish Operator (<code>&gt;=&gt;</code>)</h3>
<p>è¿™ç§ç»„åˆæ“ä½œç¬¦è¢«ç§°ä¸º <strong>Kleisli Composition</strong>ï¼Œç¬¦å·é€šå¸¸å†™ä½œ <code>&gt;=&gt;</code>ï¼ˆå½¢çŠ¶åƒä¸€æ¡é±¼ï¼‰ï¼Œä¹Ÿç§°ä¸ºâ€œé±¼æ“ä½œç¬¦â€ã€‚</p>
<p>å®šä¹‰å¦‚ä¸‹ï¼ˆä»¥ Haskell é£æ ¼ä¸ºä¾‹ï¼‰ï¼š</p>
<p>å®ƒçš„æ‰§è¡Œé€»è¾‘æ˜¯ï¼š</p>
<ol>
<li>æ‹¿åˆ°è¾“å…¥ ï¼Œä¼ ç»™ ã€‚</li>
<li>è¿è¡Œï¼Œäº§ç”Ÿ ï¼ˆæ¯”å¦‚ä¸€ä¸ª Promiseï¼‰ã€‚</li>
<li>åˆ©ç”¨ Monad çš„ <code>bind</code> () èƒ½åŠ›ï¼Œç­‰å¾…  å®Œæˆå¹¶å–å‡º ã€‚</li>
<li>å°†  ä¼ ç»™ ã€‚</li>
<li>è¿è¡Œï¼Œäº§ç”Ÿ ã€‚</li>
<li>è¿”å›è¿™ä¸ª ã€‚</li>
</ol>
<h4 id="ascii-kleisli-pipeline">ASCII æµç¨‹å›¾ï¼šKleisli Pipeline</h4>
<div class="codehilite"><pre><span></span><code>Pipeline: agent = step1 &gt;=&gt; step2 &gt;=&gt; step3

      [ Input A ]
          |
          v
    +-----------+
    |  Step 1   | f: A -&gt; m B
    +-----------+
          | outputs (m B)
          v
    [ Bind/FlatMap Magic ] &lt;--- è‡ªåŠ¨æ‹†åŒ…ï¼Œå¦‚æœæ˜¯ Error åˆ™è·³è¿‡åç»­
          | passes (B)
          v
    +-----------+
    |  Step 2   | g: B -&gt; m C
    +-----------+
          | outputs (m C)
          v
    [ Bind/FlatMap Magic ]
          | passes (C)
          v
    +-----------+
    |  Step 3   | h: C -&gt; m D
    +-----------+
          |
          v
      [ Output m D ]
</code></pre></div>

<h3 id="24-agent-pipeline">2.4 å·¥ç¨‹å®æˆ˜ï¼šé‡æ„ Agent Pipeline</h3>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸‰ä¸ªåŸå­èƒ½åŠ›ï¼ˆAtomic Capabilitiesï¼‰ï¼š</p>
<ol>
<li>
<p><code>promptTemplate</code>: å°†ç”¨æˆ·é—®é¢˜è½¬æ¢ä¸º Promptã€‚è¿™æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œä½†ä¸ºäº†ç»„åˆï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>pure</code> æå‡å®ƒï¼Œæˆ–è€…ä½¿ç”¨ <code>map</code>ã€‚
* ç±»å‹ï¼š<code>String -&gt; Prompt</code></p>
</li>
<li>
<p><code>llmInference</code>: è°ƒç”¨æ¨¡å‹ã€‚
* ç±»å‹ï¼š<code>Prompt -&gt; IO String</code></p>
</li>
<li>
<p><code>extractTool</code>: è§£æ JSONã€‚
* ç±»å‹ï¼š<code>String -&gt; IO ToolCall</code> (å‡è®¾è§£æå¤±è´¥æŠ›å‡º IO é”™è¯¯)</p>
</li>
</ol>
<p><strong>ä½¿ç”¨ Kleisli ç»„åˆçš„ä»£ç ï¼ˆä¼ªä»£ç ï¼‰ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- å®šä¹‰ pipeline</span>
<span class="nf">thinkingProcess</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="kt">ToolCall</span>
<span class="nf">thinkingProcess</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="n">pure</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">promptTemplate</span><span class="p">)</span><span class="w">  </span><span class="c1">-- 1. çº¯å‡½æ•°æå‡ä¸º Kleisli</span>
<span class="w">    </span><span class="o">&gt;=&gt;</span><span class="w"> </span><span class="n">llmInference</span><span class="w">         </span><span class="c1">-- 2. IO æ“ä½œ</span>
<span class="w">    </span><span class="o">&gt;=&gt;</span><span class="w"> </span><span class="n">extractTool</span><span class="w">          </span><span class="c1">-- 3. IO æ“ä½œ (å«è§£æé€»è¾‘)</span>

<span class="c1">-- è¿è¡Œ</span>
<span class="nf">result</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">thinkingProcess</span><span class="p">(</span><span class="s">&quot;å¸®æˆ‘æŸ¥ä¸€ä¸‹å¤©æ°”&quot;</span><span class="p">)</span><span class="w"> </span>
<span class="c1">-- result æ˜¯ IO ToolCall</span>
</code></pre></div>

<p><strong>è¿™ä¸€è¡Œçš„ä»·å€¼åœ¨äºï¼š</strong> æˆ‘ä»¬å®šä¹‰äº†<strong>æ§åˆ¶æµçš„å½¢çŠ¶</strong>ï¼Œè€Œæ²¡æœ‰æ‰§è¡Œå®ƒã€‚è¿™è®©æˆ‘ä»¬å¯ä»¥å¯¹ <code>thinkingProcess</code> è¿›è¡Œæ•´ä½“çš„æµ‹è¯•ã€è¶…æ—¶æ§åˆ¶æˆ–ä¿®é¥°ï¼Œè€Œä¸éœ€è¦æ·±å…¥åˆ°å‡½æ•°å†…éƒ¨ã€‚</p>
<h3 id="25-middleware">2.5 å¼ºå¤§çš„ä¸­é—´ä»¶èƒ½åŠ› (Middleware)</h3>
<p>Kleisli Arrow æœ€è¿·äººçš„åœ°æ–¹åœ¨äºå®ƒéå¸¸é€‚åˆåš <strong>AOP (é¢å‘åˆ‡é¢ç¼–ç¨‹)</strong>ã€‚æˆ‘ä»¬å¯ä»¥ç¼–å†™é«˜é˜¶å‡½æ•°æ¥â€œä¿®é¥°â€ä»»ä½•ä¸€ä¸ª Kleisli Arrowã€‚</p>
<h4 id="1-retry">åœºæ™¯ 1ï¼šè‡ªåŠ¨é‡è¯• (Retry)</h4>
<p>å®šä¹‰ä¸€ä¸ªä¿®é¥°å™¨ <code>withRetry</code>ï¼š</p>
<p>å®ƒæ¥æ”¶ä¸€ä¸ªç®­å¤´ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ç®­å¤´ï¼šå¦‚æœåŸç®­å¤´å¤±è´¥ï¼Œæ–°ç®­å¤´ä¼šé‡è¯• N æ¬¡ã€‚</p>
<h4 id="2-tracing">åœºæ™¯ 2ï¼šé“¾è·¯è¿½è¸ª (Tracing)</h4>
<p>å®šä¹‰ <code>withTrace(name)</code>ï¼š
å®ƒä¼šåœ¨æ‰§è¡Œå‰åè®°å½•å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œå¹¶å‘åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿå‘é€ Spanã€‚</p>
<h4 id="agent">ç»„åˆåçš„ Agentï¼š</h4>
<div class="codehilite"><pre><span></span><code>robustAgent = 
   (pure . template)
   &gt;=&gt; withTrace(&quot;LLM_Call&quot;, withRetry(3, llmInference))  // å¸¦è¿½è¸ªå’Œé‡è¯•çš„ LLM
   &gt;=&gt; withTrace(&quot;Parser&quot;, extractTool)                   // å¸¦è¿½è¸ªçš„è§£æ
</code></pre></div>

<p>è¿™ç§<strong>å£°æ˜å¼</strong>çš„å†™æ³•ï¼Œè®©â€œåŠŸèƒ½éœ€æ±‚â€ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰å’Œâ€œéåŠŸèƒ½éœ€æ±‚â€ï¼ˆç¨³å®šæ€§ã€è§‚æµ‹æ€§ï¼‰å®Œå…¨è§£è€¦ã€‚</p>
<h3 id="26-kleisli-vs">2.6 Kleisli çš„å±€é™æ€§ï¼šä¸²è¡Œ vs å¹¶è¡Œ</h3>
<p>Kleisli Arrow æœ¬è´¨ä¸Šæ˜¯<strong>ä¸²è¡Œ</strong>çš„ï¼ˆSequentialï¼‰ã€‚
<code>f &gt;=&gt; g</code> æ„å‘³ç€  å¿…é¡»ç­‰å¾…  å®Œæˆæ‰èƒ½è·å¾—è¾“å…¥ã€‚</p>
<p>å¦‚æœä½ éœ€è¦<strong>å¹¶è¡Œ</strong>ï¼ˆä¾‹å¦‚ï¼šåŒæ—¶è°ƒç”¨ 3 ä¸ªä¸åŒçš„ LLM æ¨¡å‹æŠ•ç¥¨ï¼‰ï¼ŒKleisli Arrow å°±ä¸å¤Ÿç”¨äº†ã€‚è¿™æ—¶æˆ‘ä»¬éœ€è¦å¼•å…¥ <strong>Arrow</strong> (æ›´é€šç”¨çš„æ¥å£) æˆ– <strong>Applicative Functor</strong> (<code>parMap</code>, <code>parZip</code>)ã€‚</p>
<ul>
<li><strong>Kleisli</strong>:  (é“¾å¼ä¾èµ–)</li>
<li><strong>Applicative</strong>:  (æ— ä¾èµ–å¹¶è¡Œ)</li>
</ul>
<p>åœ¨ç¬¬ 5 ç« ï¼ˆRuntimeï¼‰ä¸­ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†è®¨è®ºå¦‚ä½•åœ¨ Kleisli ç®¡é“çš„æŸä¸ªèŠ‚ç‚¹å†…éƒ¨åµŒå…¥å¹¶è¡Œè®¡ç®—ã€‚</p>
<hr />
<h2 id="3">3. æœ¬ç« å°ç»“</h2>
<ol>
<li><strong>Kleisli Arrow</strong> æ˜¯ç±»å‹ä¸º  çš„å‡½æ•°ï¼Œå®ƒæ˜¯ Agent ç³»ç»Ÿä¸­â€œå¸¦å‰¯ä½œç”¨æ­¥éª¤â€çš„æ ‡å‡†æŠ½è±¡ã€‚</li>
<li><strong>Fish Operator (<code>&gt;=&gt;</code>)</strong> æ˜¯ Kleisli çš„ç»„åˆå·¥å…·ï¼Œå®ƒè‡ªåŠ¨å¤„ç†äº† Monad ä¸Šä¸‹æ–‡çš„è§£åŒ…ä¸ä¼ é€’ï¼Œæ¶ˆé™¤äº†å›è°ƒåœ°ç‹±ã€‚</li>
<li><strong>çŸ­è·¯ç‰¹æ€§</strong>ï¼šåŸºäº <code>IO</code> æˆ– <code>Either</code> Monad çš„ Kleisli ç»„åˆå¤©ç”Ÿå…·æœ‰çŸ­è·¯èƒ½åŠ›ã€‚ä¸Šä¸€æ­¥æŠ¥é”™ï¼Œä¸‹ä¸€æ­¥è‡ªåŠ¨è·³è¿‡ã€‚</li>
<li><strong>ä¸­é—´ä»¶æ¶æ„</strong>ï¼šKleisli Arrow ææ˜“è¢«è£…é¥°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é«˜é˜¶å‡½æ•°æ— ä¾µå…¥åœ°ä¸º Agent çš„ä»»æ„æ­¥éª¤æ·»åŠ  Retryã€Timeoutã€Tracing å’Œ Loggingã€‚</li>
<li><strong>è®¾è®¡åŸåˆ™</strong>ï¼šå°† Agent æ‹†è§£ä¸ºç»†ç²’åº¦çš„ Kleisli Arrowï¼Œç„¶åé€šè¿‡ç»„åˆå­ï¼ˆCombinatorsï¼‰å°†å®ƒä»¬æ‹¼è£…æˆå®Œæ•´çš„è¿è¡Œæ—¶ã€‚</li>
</ol>
<hr />
<h2 id="4">4. ç»ƒä¹ é¢˜</h2>
<blockquote>
<p><strong>æç¤º</strong>ï¼šé™¤äº†æ€è€ƒç±»å‹ç­¾åï¼Œå°è¯•ç”¨ä½ ç†Ÿæ‚‰çš„è¯­è¨€ï¼ˆJS/TS/Pythonï¼‰æ„æ€å…¶å®ç°é€»è¾‘ã€‚</p>
</blockquote>
<h3 id="50">åŸºç¡€é¢˜ (50%)</h3>
<p><strong>Q1. ç±»å‹ä½“æ“ï¼šæ‹¼æ¥ç®¡é“</strong>
å·²çŸ¥ï¼š</p>
<ul>
<li><code>fetchUser : UserID -&gt; IO UserProfile</code></li>
<li><code>vectorSearch : UserProfile -&gt; IO [Document]</code></li>
<li><code>summarize : [Document] -&gt; IO String</code></li>
</ul>
<p>è¯·å†™å‡ºå°† <code>UserID</code> è½¬æ¢ä¸º <code>String</code> (Summary) çš„ Kleisli ç»„åˆè¡¨è¾¾å¼ã€‚
<em>(Hint: åªéœ€è¦å…³æ³¨è¾“å…¥è¾“å‡ºç±»å‹çš„é¦–å°¾ç›¸æ¥)</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ (æŠ˜å )</summary>
<p>è¡¨è¾¾å¼ï¼š
<code>fetchUser &gt;=&gt; vectorSearch &gt;=&gt; summarize</code></p>
<p>ç±»å‹æ¨å¯¼è¿‡ç¨‹ï¼š</p>
<ol>
<li><code>UserID -&gt; IO UserProfile</code></li>
<li><code>UserProfile -&gt; IO [Document]</code> (è¾“å…¥åŒ¹é…ä¸Šä¸€æ­¥çš„è¾“å‡º)</li>
<li><code>[Document] -&gt; IO String</code> (è¾“å…¥åŒ¹é…ä¸Šä¸€æ­¥çš„è¾“å‡º)
æœ€ç»ˆå¾—åˆ°ï¼š<code>UserID -&gt; IO String</code></li>
</ol>
</details>
<hr />
<p><strong>Q2. çº¯å‡½æ•°çš„ä»‹å…¥</strong>
å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªçº¯å‡½æ•° <code>filterDocs : [Document] -&gt; [Document]</code>ï¼Œå®ƒä¸è¿‡æ»¤ç½‘ç»œï¼Œåªåœ¨å†…å­˜é‡Œæ“ä½œã€‚
å¦‚ä½•å°†å®ƒæ’å…¥åˆ° Q1 çš„ç®¡é“ä¸­ <code>vectorSearch</code> å’Œ <code>summarize</code> ä¹‹é—´ï¼Ÿ
<em>(Hint: çº¯å‡½æ•°ä¸èƒ½ç›´æ¥ç”¨ <code>&gt;=&gt;</code>ï¼Œéœ€è¦æå‡)</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ (æŠ˜å )</summary>
<p>çº¯å‡½æ•° <code>A -&gt; B</code> éœ€è¦æå‡ä¸º <code>A -&gt; IO B</code> æ‰èƒ½å‚ä¸ Kleisli ç»„åˆã€‚
æ–¹æ³•æ˜¯ä½¿ç”¨ <code>pure</code> (æˆ– <code>return</code> / <code>async (x) =&gt; x</code>)ã€‚</p>
<p>è¡¨è¾¾å¼ï¼š
<code>fetchUser &gt;=&gt; vectorSearch &gt;=&gt; (pure . filterDocs) &gt;=&gt; summarize</code></p>
<p>æˆ–è€…åˆ©ç”¨ Functor çš„ <code>map</code> è¯­ä¹‰ï¼Œåœ¨ç»„åˆå¤–éƒ¨æ“ä½œï¼š
<code>fetchUser &gt;=&gt; (vectorSearch.map(filterDocs)) &gt;=&gt; summarize</code> (è¿™ç§å†™æ³•å–å†³äºå…·ä½“è¯­è¨€åº“çš„å®ç°ï¼Œç¬¬ä¸€ç§æ›´é€šç”¨)</p>
</details>
<hr />
<p><strong>Q3. TypeScript å®ç°</strong>
åœ¨ TypeScript ä¸­å®ç° <code>composeK</code> (å³ <code>&gt;=&gt;</code>)ã€‚
ç±»å‹å®šä¹‰å‚è€ƒï¼š<code>type KFunc&lt;A, B&gt; = (a: A) =&gt; Promise&lt;B&gt;</code>ã€‚</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ (æŠ˜å )</summary>
<div class="codehilite"><pre><span></span><code><span class="c1">// è¿™æ˜¯ä¸€ä¸ªæ³›å‹çš„é«˜é˜¶å‡½æ•°</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">composeK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">A</span><span class="p">,</span><span class="w"> </span><span class="nx">B</span><span class="p">,</span><span class="w"> </span><span class="nx">C</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="nx">f</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="kt">A</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">B</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">g</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="kt">B</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">C</span><span class="o">&gt;</span>
<span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="kt">A</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">C</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">f</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span><span class="w"> </span><span class="c1">// 1. æ‰§è¡Œ f å¹¶ç­‰å¾…è§£åŒ…</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">g</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span><span class="w">          </span><span class="c1">// 2. å°†ç»“æœä¼ ç»™ g å¹¶è¿”å›</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">};</span>

<span class="c1">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="c1">// const pipeline = composeK(step1, step2);</span>
</code></pre></div>

</details>
<hr />
<h3 id="50_1">æŒ‘æˆ˜é¢˜ (50%)</h3>
<p><strong>Q4. "Circuit Breaker" (ç†”æ–­å™¨) ä¸­é—´ä»¶</strong>
è®¾è®¡ä¸€ä¸ªé«˜é˜¶å‡½æ•° <code>circuitBreaker</code>ï¼Œå®ƒåŒ…è£…ä¸€ä¸ª Kleisli Arrowã€‚
é€»è¾‘ï¼šå¦‚æœæœ€è¿‘ 5 æ¬¡è°ƒç”¨ä¸­æœ‰ 3 æ¬¡å¤±è´¥ï¼Œåˆ™åœ¨æ¥ä¸‹æ¥çš„ 1 åˆ†é’Ÿå†…ç›´è¿”å› Errorï¼Œä¸å†å®é™…æ‰§è¡Œè¢«åŒ…è£…çš„å‡½æ•°ã€‚
é—®é¢˜ï¼šå®ç°è¿™ä¸ªé€»è¾‘éœ€è¦ä»€ä¹ˆé¢å¤–çš„â€œå‰¯ä½œç”¨â€ï¼Ÿè¿™æ˜¯å¦ç ´åäº† Kleisli çš„çº¯ç²¹æ€§ï¼Ÿ
<em>(Hint: <code>IO</code> Monad å†…éƒ¨å¯ä»¥åŒ…å« <code>State</code> æˆ– <code>Ref</code>)</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ (æŠ˜å )</summary>
<p><strong>æ‰€éœ€èƒ½åŠ›</strong>ï¼šéœ€è¦ä¸€ä¸ªå¯å˜çš„ã€è·¨è¯·æ±‚æŒä¹…åŒ–çš„çŠ¶æ€ï¼ˆState/Refï¼‰ï¼Œç”¨æ¥è®°å½•å¤±è´¥è®¡æ•°å’Œä¸Šæ¬¡å¤±è´¥æ—¶é—´ã€‚</p>
<p><strong>ç±»å‹ç­¾åè®¾è®¡</strong>ï¼š
<code>circuitBreaker : StateRef -&gt; (A -&gt; IO B) -&gt; (A -&gt; IO B)</code></p>
<p><strong>çº¯ç²¹æ€§åˆ†æ</strong>ï¼š
è¿™<strong>æ²¡æœ‰</strong>ç ´åçº¯ç²¹æ€§ï¼Œå‰ææ˜¯â€œè¯»å–/å†™å…¥çŠ¶æ€â€è¿™ä¸ªåŠ¨ä½œæœ¬èº«è¢«å°è£…åœ¨äº† <code>IO</code> Effect ä¸­ã€‚
å½“æˆ‘ä»¬ç»„åˆå‡ºè¿™ä¸ª Agent æ—¶ï¼Œæˆ‘ä»¬åªæ˜¯æ„å»ºäº†ä¸€ä¸ªâ€œæè¿°â€ã€‚åªæœ‰å½“ Agent è¿è¡Œæ—¶ï¼Œè¿™ä¸ªçŠ¶æ€æ‰ä¼šè¢«ä¿®æ”¹ã€‚
åœ¨ Haskell/Scala Cats ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ <code>Ref[IO, BreakerState]</code> æ¥å®ç°è¿™ç§å¹¶å‘å®‰å…¨çš„å†…éƒ¨çŠ¶æ€ã€‚</p>
</details>
<hr />
<p><strong>Q5. åˆ†æ”¯é€»è¾‘ (Switching)</strong>
æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ ¹æ®ä¸Šä¸€æ­¥çš„ç»“æœå†³å®šä¸‹ä¸€æ­¥èµ°å“ªæ¡è·¯ï¼ˆä¾‹å¦‚ï¼šå¦‚æœæ„å›¾æ˜¯ "Search" èµ°æœç´¢ç®¡é“ï¼Œå¦‚æœæ˜¯ "Chat" èµ°é—²èŠç®¡é“ï¼‰ã€‚
è¯·å®šä¹‰ä¸€ä¸ªå‡½æ•° <code>branch</code>ï¼š
è¾“å…¥ï¼š</p>
<ol>
<li><code>check : A -&gt; Boolean</code> (åˆ¤æ–­æ¡ä»¶)</li>
<li><code>ifTrue : A -&gt; IO B</code> (Kleisli Arrow 1)</li>
<li><code>ifFalse : A -&gt; IO B</code> (Kleisli Arrow 2)
è¾“å‡ºï¼š
<code>A -&gt; IO B</code></li>
</ol>
<p>è¯·é—®è¿™ä¸ª <code>branch</code> å‡½æ•°æœ¬èº«æ˜¯ Kleisli Arrow å—ï¼Ÿå®ƒèƒ½è¢«ç»„åˆè¿›ç®¡é“å—ï¼Ÿ</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ (æŠ˜å )</summary>
<p><strong>å®ç°é€»è¾‘</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">check</span><span class="p">,</span><span class="w"> </span><span class="nx">ifTrue</span><span class="p">,</span><span class="w"> </span><span class="nx">ifFalse</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">input</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">check</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">ifTrue</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">ifFalse</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å›ç­”</strong>ï¼š
æ˜¯çš„ï¼Œ<code>branch</code> è¿”å›çš„ç»“æœä¾ç„¶æ˜¯ä¸€ä¸ª <code>A -&gt; IO B</code> ç±»å‹çš„å‡½æ•°ã€‚
å› æ­¤ï¼Œå®ƒ<strong>å®Œç¾ç¬¦åˆ</strong> Kleisli Arrow çš„å®šä¹‰ã€‚
ä½ å¯ä»¥æŠŠå®ƒåƒæ™®é€šæ­¥éª¤ä¸€æ ·ç»„åˆè¿›ç®¡é“ï¼š
<code>preprocess &gt;=&gt; branch(isSearch, searchPipe, chatPipe) &gt;=&gt; postprocess</code>
è¿™å°±æ˜¯ Kleisli çš„å¼ºå¤§ä¹‹å¤„ï¼š<strong>æ§åˆ¶æµä¹Ÿæ˜¯ç®¡é“çš„ä¸€éƒ¨åˆ†</strong>ã€‚</p>
</details>
<hr />
<p><strong>Q6. è°ƒè¯• Kleisli</strong>
åœ¨ä¸€ä¸ªé•¿é•¿çš„ <code>f &gt;=&gt; g &gt;=&gt; h &gt;=&gt; ...</code> é“¾æ¡ä¸­ï¼Œå¦‚æœä¸­é—´æŸä¸€æ­¥æ•°æ®ä¸å¯¹ï¼Œå¦‚ä½•è°ƒè¯•ï¼Ÿ
èƒ½ä¸èƒ½å†™ä¸€ä¸ª <code>tap</code> å‡½æ•°ï¼Œå…è®¸æˆ‘ä»¬åœ¨ç®¡é“ä¸­é—´ <code>console.log</code> æ•°æ®ï¼Œä½†ä¸æ”¹å˜æ•°æ®æµå‘ï¼Ÿ</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ (æŠ˜å )</summary>
<p>å¯ä»¥ã€‚è¿™ä¸ªæ¨¡å¼é€šå¸¸å« <code>tap</code> æˆ– <code>inspect</code>ã€‚</p>
<p><strong>å®šä¹‰</strong>ï¼š
<code>tap : (A -&gt; IO Unit) -&gt; (A -&gt; IO A)</code>
æˆ–è€…æ›´ç®€å•ç‰ˆæœ¬ï¼ˆåªæ‰“å°ï¼‰ï¼š
<code>logResult : String -&gt; (A -&gt; IO A)</code></p>
<p><strong>å®ç° (TS)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">inspect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">A</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">tag</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">A</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">A</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">tag</span><span class="si">}</span><span class="sb">]`</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">x</span><span class="p">;</span><span class="w"> </span><span class="c1">// åŸæ ·è¿”å›ï¼Œä¿æŒç®¡é“æµåŠ¨</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>ä½¿ç”¨</strong>:
<code>step1 &gt;=&gt; inspect("After Step1") &gt;=&gt; step2</code>
è¿™è®©è°ƒè¯•å˜å¾—åƒåœ¨ç®¡é“ä¸Šæ‰“å­”ä¸€æ ·ç®€å•ã€‚</p>
</details>
<hr />
<h2 id="5-gotchas">5. å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="1">1. éšå¼çŠ¶æ€ä¸¢å¤±</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šåœ¨ç®¡é“çš„ä¸€å¼€å§‹è·å–äº† <code>UserID</code>ï¼Œä½†åœ¨æ‰§è¡Œäº† 3 æ­¥ä¹‹åï¼Œç¬¬ 4 æ­¥åˆéœ€è¦ <code>UserID</code>ã€‚</li>
<li><strong>é”™è¯¯</strong>ï¼šå› ä¸º Kleisli æ˜¯ <code>A -&gt; m B</code>, <code>B -&gt; m C</code>ï¼Œä¸­é—´çš„ä¿¡æ¯å¦‚æœæ²¡æœ‰æ˜¾å¼ä¼ é€’ï¼Œå°±ä¼šä¸¢å¤±ã€‚</li>
<li><strong>è§£å†³</strong>ï¼š</li>
<li><strong>Payload ä¼ é€’</strong>ï¼šè®©æ¯ä¸€æ­¥è¿”å› <code>(Result, Context)</code> å…ƒç»„ã€‚</li>
<li><strong>Reader Monad</strong>ï¼šå°† Monad æ ˆå‡çº§ä¸º <code>ReaderT Context IO</code>ï¼Œè¿™æ ·ä»»ä½•æ­¥éª¤éƒ½å¯ä»¥éšæ—¶ <code>ask</code> è·å–ç¯å¢ƒä¿¡æ¯ã€‚</li>
</ul>
<h3 id="2-error-error">2. è¿™é‡Œçš„ <code>Error</code> åˆ°åº•æ˜¯è°çš„ <code>Error</code>ï¼Ÿ</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šLLM è¿”å›äº† <code>"I don't know"</code>ï¼ˆä¸šåŠ¡å±‚é¢çš„å¤±è´¥ï¼‰ï¼Œä½† IO Monad è®¤ä¸ºè¿™æ˜¯æˆåŠŸçš„ï¼ˆç½‘ç»œè¯·æ±‚æˆåŠŸäº†ï¼‰ã€‚</li>
<li><strong>é™·é˜±</strong>ï¼šç›´æ¥ç”¨ <code>IO</code> çš„é”™è¯¯æœºåˆ¶å¤„ç†ä¸šåŠ¡é€»è¾‘é”™è¯¯ã€‚</li>
<li><strong>æœ€ä½³å®è·µ</strong>ï¼š</li>
<li><strong>IO Error</strong> (Exception)ï¼šä¿ç•™ç»™ç½‘ç»œæ–­è¿ã€è¶…æ—¶ã€API 500 ç­‰åŸºç¡€è®¾æ–½é”™è¯¯ã€‚</li>
<li><strong>Domain Error</strong> (Either)ï¼šLLM æ‹’ç»å›ç­”ã€å·¥å…·å‚æ•°è§£æé”™è¯¯ç­‰ï¼Œåº”è¯¥ä½œä¸º<strong>è¿”å›å€¼</strong>çš„ä¸€éƒ¨åˆ†ï¼ˆ<code>IO (Either Refusal Answer)</code>ï¼‰ï¼Œè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚</li>
</ul>
<h3 id="3-promise-hell">3. "Promise Hell" çš„å˜ä½“</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šè™½ç„¶ç”¨äº† Kleisli æ¦‚å¿µï¼Œä½†å®ç°æ—¶è¿˜æ˜¯æ‰‹åŠ¨å†™ <code>step1().then(res =&gt; step2(res))</code>ã€‚</li>
<li><strong>å»ºè®®</strong>ï¼šä¸€å®šè¦å°è£…é€šç”¨çš„ <code>compose</code> æˆ– <code>pipe</code> å‡½æ•°ã€‚å¦‚æœè¯­è¨€æ”¯æŒï¼ˆå¦‚ F# <code>&gt;=&gt;</code>, Haskell <code>&gt;=&gt;</code>, Scala Cats <code>andThen</code>ï¼‰ï¼Œè¯·ç›´æ¥ä½¿ç”¨åº“å‡½æ•°ã€‚åœ¨ TS/JS ä¸­ï¼Œä½¿ç”¨ <code>fp-ts</code> æˆ–ç®€å•çš„ utility function æ¥ä¿æŒä»£ç çš„å¹³é“ºã€‚</li>
</ul>
<h3 id="4-pure">4. å¿½ç•¥äº† <code>pure</code> çš„å¼€é”€</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼šæŠŠå¤§é‡çš„çº¯è®¡ç®—é€»è¾‘ï¼ˆå¦‚å¤æ‚çš„å­—ç¬¦ä¸²æ­£åˆ™åŒ¹é…ï¼‰å¼ºè¡Œæ‹†æˆå¾®å°çš„ Kleisli Arrowã€‚</li>
<li><strong>æƒè¡¡</strong>ï¼šè™½ç„¶ç»„åˆæ€§å¥½äº†ï¼Œä½†æ¯æ¬¡ <code>pure</code> æå‡å¹¶åœ¨ Monad ä¸­ bind éƒ½ä¼šå¸¦æ¥å¾®å°çš„è¿è¡Œæ—¶å¼€é”€ï¼ˆEvent Loop tickï¼‰ã€‚å¯¹äºæåº¦å¯†é›†çš„ CPU è®¡ç®—ï¼Œç›´æ¥å†™æˆçº¯å‡½æ•°å—ï¼Œåªåœ¨æœ€åæå‡ä¸€æ¬¡å³å¯ã€‚</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter2.html" class="nav-link prev">â† Chapter 2 â€” IO Monad é€Ÿæˆï¼šä»æ¦‚å¿µåˆ°å·¥ç¨‹å®ç°</a><a href="chapter4.html" class="nav-link next">Chapter 4 â€” Agent DSLï¼šæŠŠå·¥å…·ã€è®°å¿†ä¸æ§åˆ¶æµåšæˆâ€œå¯è§£é‡Šçš„ effectâ€ â†’</a></nav>
        </main>
    </div>
</body>
</html>